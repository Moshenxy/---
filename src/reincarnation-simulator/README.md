# 轮回模拟器 - 前端界面

本项目是“轮回-诸天万界”世界观的前端UI实现，基于Vue 3、TypeScript和SCSS构建，旨在提供一个沉浸式、数据驱动的交互体验。

## 近期重要更新 (V7.0 - 世界沙盘)

1.  **【核心】世界沙盘 (World Sandbox) 可视化**:
    *   **新增 `WorldSandboxPanel`**: 引入了一个全新的、基于 `D3.js` 的交互式星图，用于可视化世界中的“空间实体”及其层级关系。
    *   **核心服务**:
        *   `CoordinateService.ts`: 负责将世界书中的“相对坐标”（如 `方位: "['东北', 45]"`）解析为屏幕上的精确 `(x, y)` 坐标。
        *   `WorldMapParser.ts`: 为沙盘功能定制的、用于解析世界书 `自动化规则` 文本的非标准YAML解析器。
        *   `WorldMapLayoutService.ts`: 核心布局算法服务，使用力导向图模拟，根据实体间的“所属”关系和相对坐标，计算出最终的节点位置，确保了星图的动态性和可读性。
    *   **数据流**: `LorebookService` -> `WorldMapParser` -> `WorldMapLayoutService` -> `WorldMapView (D3.js)`，实现了从原始文本到可视化视图的完整数据转换与渲染。

## 近期重要更新 (V6.0 - 深化与精简)

为进一步提升AI角色扮演的深度和内在逻辑，V6.0版本遵循“**深化而非扩展**”的核心设计哲学，对后端核心数据结构进行了一次精准的精简与重构。前端UI和服务已全面适配此改动。

1.  **【核心】AI驱动逻辑深化**:
    *   **移除`生活模式`**: 彻底移除了 `角色.心流.生活模式` 模块和顶层的 `数据库.活动模板`。此举旨在消除繁琐的日常行为模拟，让AI的行为驱动更加聚焦于其内在的核心动机、情感和性格特质，从而在关键剧情点上实现更高质量的角色扮演。
    *   **引入`内在准则`**: 在 `角色.背景.性格特质` 中新增了“内在准则”字段。它为AI提供了一个比普通性格标签更高层次的、更稳定的行为与道德逻辑框架，使其决策更具一致性和深度。

2.  **【核心】能力与关系结构化**:
    *   **新增`技艺`系统**:
        *   在 `数据库` 中新增了独立的 `技艺技能` 模板库，用于结构化地定义角色通过学习和训练所能掌握的各种非战斗能力（如琴棋书画、锻造炼金）。
        *   `角色` 对象中新增 `技艺` 模块，通过ID引用这些技艺模板，实现了角色能力的结构化和可扩展管理，取代了原先宽泛的“世界专属属性”。
    *   **强化`因果之网`**: 在 `因果之网` 的关系结构中新增了 `因果标签` 字段。该字段用于记录角色间关键互动所产生的、具有长期影响的状态或标记（如“救命之恩”、“一饭之缘”），为AI的社交行为提供了更精确、更具叙事性的驱动力。

这些改动旨在构建一个数据关联更紧密、逻辑更自洽、能让AI进行更深度角色扮演的开局环境与持续演化的世界。

## 近期重要更新 (V5.0 - AI认知优化)

为提升AI在剧情推演中的逻辑一致性和角色扮演的深度，我们对核心数据结构、AI思考链及数值判定系统进行了一次全面的V5.0版本重构。

1.  **【核心】数据结构 V5.0 重构 (“AI驱动”)**:
    *   **`心流`统一驱动模型**: 彻底重构了 `[InitVar].txt` 中的 `角色` 数据结构。移除了 `生活节律`、`长期目标`、`短期目标`、`行动倾向` 等分散的字段，将其统一整合进 `心流` 对象下的 `驱动力` 和 `生活模式` 模块。这使得 `心流` 成为AI推演角色行为的**唯一决策中心**。
    *   **`背景`模块抽象**: 将相对静态的 `过去经历` 和 `性格特质` 归入新增的 `背景` 模块，使角色定义更清晰。
    *   **`文明`模块移除**: 为降低AI认知负荷，移除了世界定义中的 `文明` 模块，AI将直接通过`势力`、`历史`等更具体的条目来理解世界风貌。

2.  **【后台】全面适配 V5.0**:
    *   **COT思考链升级**:
        *   **全息角色侧写**: 在 `【cot】天衍之心` 中加入了“全息角色侧写”强制步骤，要求AI在决策前，必须全面审视角色的静态背景、动态内心、记忆知识和社交立场。
        *   **三轨推演**: 引入“三轨推演”机制，要求AI构思三种剧情走向（最可能、最有趣、最符合宿命），并以“天衍”的人格进行选择，极大地丰富了剧情的动态性和创造性。
    *   **数值系统优化 (V8版)**:
        *   **“难度系数”公式**: 彻底重构了 `【判定】数值判定.txt` 中的DC计算公式，引入 `世界能级` 作为“难度系数”，完美解决了低级角色在低能级世界“寸步难行”以及高级角色被过度压制的问题。
        *   **气运重投**: 新增“气运重投”机制，让`运`属性成为真正能够“逆天改命”的关键属性。
    *   **能级简化**: 将 `[世界观]宏观参数参考.txt` 中的世界能级从30级精简为更易于AI处理的18级（6大段位*3子等级）。

## 项目结构

* **/components**: 存放Vue通用组件。
  * `TopStatusBar.vue`: 顶部状态栏，显示世界时间等核心信息。
  * `SideMenuButton.vue` & `RadialMenu.vue`: **轮盘菜单系统**，取代了原有的固定侧边栏，通过点击屏幕两侧的按钮，在屏幕中央展开一个动态的轮盘菜单，用于触发各项功能。
  * `DockManager.vue`: 基于 `dock-spawn-ts` 的核心布局管理器，负责所有面板的停靠、拖拽和管理。
  * `InputHistoryPopup.vue`: **（新增）** 一个配合输入框使用的弹出组件，用于显示、选择和管理输入历史。
  * `/panels`: 存放所有可停靠的功能面板组件。
    * `CharacterPanel.vue`: 以“**命盘**”形式动态显示玩家本体的核心属性，包括基础潜力、战斗参数和世界专属属性。
    * `InventoryPanel.vue`: 分类展示玩家的消耗品、奇物、材料和羁绊。
    * `SkillsPanel.vue`: **（新增）** 以可折叠列表形式，展示角色已掌握的“技艺”及其关联的“技能”。
    * `ImprintsPanel.vue`: 以“**九宫格**”布局展示已固化的轮回烙印。
    * `WorldDetailsPanel.vue`: **（重构）** 动态展示主世界或化身世界的“元规则”、“纪元规则”和“力量体系”，并支持在不同历史纪元间切换查看。
    * `ReincarnationPanel.vue`: 轮回操作的核心面板，集成了待选世界、可选化身、宿命抉择、本世历程和新增的“往世涟漪”页签。
* **/core**: 包含项目核心加载与初始化逻辑。
* **/services**: 存放与后端和数据处理相关的服务。
  * `DockManagerService.ts`: 封装 `dock-spawn-ts` 的所有操作，提供打开、管理面板的接口。
  * `usePanelManager.ts`: **（核心重构）** 一个Vue Composable，集中管理所有面板的注册信息和开启逻辑，被左右侧边栏复用。
  * `InputHistoryService.ts`: **（新增）** 负责管理输入框的历史记录，包括最近输入和用户收藏的条目，并提供持久化存储。
  * `LorebookService.ts`: 提供读写世界书（Lorebook）的接口。
  * `NpcService.ts`: 提供NPC数据的查询和处理服务。
* **/store**: 状态管理中心。
  * `state.ts`: 定义全局响应式状态 `store`。
  * `getters.ts`: **（核心数据枢纽）** 从 `store` 中派生计算属性，适配新的数据结构（如 `playerInventory`, `因果之网`）。
  * `actions.ts`: 封装所有修改 `store` 的异步操作和业务逻辑。
* **/styles**: 存放全局SCSS样式文件。
  * `/theme`: 存放“归墟道镜”主题的核心文件。
* **/types**: **核心类型定义中心**。此目录下的 `schema.ts` 使用 Zod 库定义了整个应用的核心数据结构。它不仅与 `[InitVar].txt` 的最新结构保持同步，更重要的是，它负责在运行时对从酒馆后端获取的数据进行严格的校验、解析和转换。通过为字段提供默认值（`prefault`）和自定义转换逻辑（`transform`），该 Schema 极大地增强了应用的健壮性，确保了前端接收到的数据始终是类型安全且结构完整的，是整个前端数据流正确性的基石。
* `app.vue`: 应用的根组件，负责整合**主视图**和新的**轮盘菜单系统**。
* `index.ts`: 项目主入口文件。
* `index.html`: UI的HTML入口。

## 核心数据模型 (V6.0)

为与最新的 `[系统]变量更新规则.txt` 和 `[InitVar].txt` 保持一致，前端的数据模型已全面升级：

1.  **【角色】AI驱动模型**:
    *   **`心流`为核心**: 角色的所有行为决策依据，包括情绪、需求、长期/短期目标、决策倾向和行为习惯，现已全部统一到 `角色.心流` 对象中。
    *   **`背景`为根基**: 角色的静态描述，如 `过去经历` 和 `性格特质`（包含新增的`内在准则`），被归纳到新的 `背景` 对象中。
    *   **前端实现**: `CharacterPanel`、`SkillsPanel` 等所有相关Vue组件和`getter`都已更新，以从新的数据路径中获取信息。

2.  **【世界】纪元中心化**:
    *   所有世界的核心定义（规则、力量体系等）都嵌套在各自的 `历史纪元` 对象下。
    *   **前端实现**: `WorldDetailsPanel` 等相关面板已重构，能够正确解析新的数据层级，并从中提取当前激活的纪元数据供UI使用。

3.  **【数据库与社交】**:
    *   **ID引用模型** 保持不变。
    *   **`因果之网`** 结构中增加了 `因果标签`，前端相关服务已适配。
    *   **`数据库`** 中新增了 `技艺` 和 `技能` 模板库，前端的 `SkillsPanel` 已能正确解析和展示。

### 面板管理 (`usePanelManager.ts`)

所有面板的注册信息（组件、标题等）和开启逻辑都被统一封装在 `usePanelManager` 这个Vue Composable中。左右两个侧边栏都从这里导入 `openPanel` 函数，实现了逻辑的复用，极大地简化了组件代码并提高了可维护性。

### 面板默认行为

通过修改 `DockManagerService.ts`，所有新打开的面板现在将**默认以浮动形式在屏幕中央开启**，而不是自动停靠在侧边，给予了用户更大的自由度。

## 新增功能

### 面板固定

所有浮动面板的标题栏右侧新增了一个“图钉”按钮。点击此按钮可以**锁定或解锁**当前面板的位置和大小，防止在拖拽其他面板时不小心移动到已安排好的布局。

### 输入历史记录

为了提升用户体验，底部输入框现已集成历史记录功能：

* **历史弹窗**: 点击输入框旁的“历史”按钮，即可打开历史记录弹窗。
* **最近输入**: 系统会自动保存最近的5条成功提交的输入内容。
* **收藏夹**: 您可以从“最近输入”中选择最多5条常用的指令进行收藏，方便快速调用。
* **持久化**: 所有历史记录都会保存在本地，刷新页面后不会丢失。

### 新增功能与UI优化

* **技艺面板**: 新增了独立的“技艺”面板，用于展示角色掌握的非战斗能力及其解锁的技能。
* **角色命盘**: `CharacterPanel` 中的“命盘”UI现在完全由实时数据驱动，准确反映角色的各项核心属性。
* **世界详情**: `WorldDetailsPanel` 经过重构，不仅视觉风格得到了统一，还增加了在不同“历史纪元”之间切换查看的功能。
* **面板固定**: 所有浮动面板的标题栏右侧新增了一个“图钉”按钮。点击此按钮可以**锁定或解锁**当前面板的位置和大小，防止在拖拽其他面板时不小心移动到已安排好的布局。
* **输入历史记录**: 为了提升用户体验，底部输入框现已集成历史记录功能：
  * **历史弹窗**: 点击输入框旁的“历史”按钮，即可打开历史记录弹窗。
  * **最近输入**: 系统会自动保存最近的5条成功提交的输入内容。
  * **收藏夹**: 您可以从“最近输入”中选择最多5条常用的指令进行收藏，方便快速调用。
  * **持久化**: 所有历史记录都会保存在本地，刷新页面后不会丢失。
* **视觉升级：归墟道镜**:
  * **轮回烙印**: 已重构为“**九宫格**”布局，并带有基于能级的辉光效果。
  * **全局样式**:
    * 所有面板都拥有了“**流动光效**”边框。
    * 优化了字体清晰度，移除了可能导致模糊的背景效果。
    * **背包面板重塑**: 对背包界面进行了“画卷”主题的视觉重塑，将物品分类标题设计为“印章”样式，物品本身设计为具有环绕文字的“平安扣”玉佩样式，并全面实现了响应式缩放。
    * **布局优化**: 修复了主界面在不同屏幕比例下底部出现空白和内容拉伸的问题，现在界面将保持固定的宽高比并垂直居中显示。

## 开发规范

* **类型优先**: 所有核心数据结构都必须在 `/types` 目录中定义清晰的TypeScript接口。
* **逻辑分离**: 业务逻辑、数据获取和转换应尽可能放在 `store/actions.ts` 和 `store/getters.ts` 中。共享的UI逻辑（如面板管理）应抽象为Composable。
* **注释清晰**: 所有新添加的文件和复杂逻辑都应有清晰的JSDoc注释。
