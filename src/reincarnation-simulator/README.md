# 轮回模拟器 - 前端界面

本项目是“轮回-诸天万界”世界观的前端UI实现，基于Vue 3、TypeScript和SCSS构建，旨在提供一个沉浸式、数据驱动的交互体验。

## 近期重要更新 (V18.0 - AI复盘机制 & UI稳定性修复)

1.  **【核心·AI交互】引入“变量复盘”机制**:
    *   **闭环反馈**: 为了让AI（天衍）能更好地理解其自身行为的后果，我们实现了一个新的反馈机制。现在，每次用户提交行动时，系统都会自动将在上一次AI响应中生成的`<JSONPatch>`变量更新内容，作为“上次更新的变量”附加上下文，一并发送给AI。
    *   **自我纠错**: 这使得AI能够“复盘”它上一次的变量更新是否准确、是否遗漏了某些必要的变更。基于这个复盘，AI可以在本次的推演中进行自我修正，显著提高了数据处理的长期一致性和准确性。

2.  **【UI·稳定性】修复沙盘与记忆面板的渲染问题**:
    *   **沙盘黑屏修复**: 彻底解决了新打开的“世界沙盘”面板内容为空白（黑屏）的问题。通过将渲染逻辑与`golden-layout`面板的`show`和`resize`事件进行绑定，确保了只有当面板容器真正可见并获得尺寸后，沙盘的D3.js渲染逻辑才会被触发。
    *   **记忆UI同步**: 修复了“记忆系统”面板在打开状态下，内容不会随AI回复而自动更新的问题。通过引入`EventBus`事件总线，`MemoryService`在更新记忆内容后会发出`memory-updated`事件，`MemoryPanel.vue`组件监听到该事件后会自动刷新UI，实现了数据的响应式同步。

## 近期重要更新 (V17.0 - 世界演化引擎与动态上下文)

1.  **【核心·世界引擎】引入“演化压力”与“时空延迟”模型**:
    *   **世界自身脉搏**: 重构了核心事件循环，引入了`WorldEvolutionService`。该服务会在后台独立推演，根据NPC的欲望、势力的生存需求等内在矛盾，主动生成“演化压力”。
    *   **因果的涟漪**: 当压力积累到阈值，会触发与玩家无关的“远方事件”（如宗门宣战、边境摩擦）。这些事件的后果会作为“信息涟漪”，被置入一个带有时间延迟的全局队列。
    *   **时空法则**: “涟漪”的传播速度由世界自身的`信息传播法则`（如信鸦、灵网、流言）和空间距离决定。这意味着玩家收到的情报天然地具有“延迟”，你今天听到的，可能是数日前千里之外发生之事的余波。

2.  **【核心·上下文】引入“叙事引力”与“双环推演”模型**:
    *   **“你”不再是中心**: `ContextService`的构建逻辑被彻底颠覆。它不再以玩家的意图为起点，而是以“世界脉搏”为起点。
    *   **叙事引力**: 在分析玩家指令前，系统会先从“信息延迟队列”中获取所有“本回合已抵达”的涟漪。与玩家当前状态（位置、任务、关系）最相关的涟漪，会被“叙事引力”捕获，成为最高优先级的“叙事素材”。
    *   **双环推演**: AI的思考链（`【cot】天衍之心.txt`）被重构为“始末相应”的双环结构：
        *   **【始】环**: 以“叙事素材”为核心，构建一个充满“背景音”的、动态的初始上下文。
        *   **【末】环**: 在推演完玩家行动后，再次调用世界引擎，将玩家行动的后果，转化为新的“涟漪”，投入延迟队列，成为未来某个时刻的“背景音”。
    *   **沉浸感升华**: 在此模型下，世界拥有了独立于玩家意志的、自行运转的生命力。玩家不再是世界的“提线人”，而是投身于一条早已波涛汹涌的因果长河中的“最大变数”。

## 近期重要更新 (V16.0 - 轮回流程适配与星图动画修复)

1.  **【核心】轮回状态机重构**:
    *   **引入 `simulatorStatus` Getter**: 在 `store/getters.ts` 中新增了 `simulatorStatus` 计算属性, 它会根据 `store.worldState.玩家.模拟器` 的状态, 返回一个统一的、明确的当前轮回阶段字符串 (如 `world-selection`, `avatar-selection`, `settlement` 等)。
    *   **状态驱动UI**: 重构了主轮回面板 `ReincarnationPanel.vue`, 其内部的标签页切换、激活和禁用逻辑现在完全由 `simulatorStatus` 驱动, 取代了之前混乱的、依赖多个不同 `getter` 的旧逻辑。

2.  **【数据】前端数据源适配**:
    *   **`WorldSelection.vue` 重构**: 彻底重写了世界选择页面的数据加载逻辑。它现在直接从 `store.worldState.世界` 中读取结构化的世界和纪元数据, 不再依赖于解析世界书条目, 并支持了在详情面板中通过标签页切换查看不同纪元的信息。
    *   **`SettlementView.vue` 修复**: 修正了结算页面的数据路径, 使其能够正确地从 `store.worldState.玩家.模拟器.结算.宿命抉择` 中获取并显示选项。

3.  **【动画】星图渲染优化**:
    *   **修复闪烁问题**: 重构了 `StarMapService.ts` 中的 `createStars` 方法, 使其遵循 “进入-更新-退出” (enter-update-exit) 的数据绑定模式。
    *   **平滑过渡**: 现在, 当“重演天机”后, 新的世界星体会平滑地淡入, 旧的则会淡出, 而已存在的星体会平滑地过渡其颜色(从未选中到选中), 彻底解决了此前因粗暴地“先清空再重建”导致的星图闪烁问题。
    *   **速度与时间流速挂钩**: 修正了公转速度的计算公式, 使其现在完全由每个世界自身的“时间流速”决定, 提供了更直观的视觉反馈。

## 近期重要更新 (V14.0 - 智能上下文系统)

1.  **【核心优化】精简上下文 (`stat_data`) 重构**:
    *   **意图驱动**: 引入了 `analyzeUserIntent` 服务，不再被动地加载数据，而是主动分析用户输入意图（如“战斗”、“社交”、“探索”），并据此动态调整数据加载策略。
    *   **全局实体索引**: 新增 `EntityIndexService`，在应用启动时建立包含所有世界、纪元、物品和地点的全局索引。这使得AI能够理解跨世界/跨纪元的查询，并自动按需加载相关数据。
    *   **数据粒度控制**: 根据意图智能裁剪数据。例如，在“社交”意图中，只加载角色的性格和关系，不加载庞大的背包数据；在“战斗”意图中，则重点加载战斗参数和装备。
    *   **世界书集成**: 现在，`ContextService` 能够识别文本中提及的地点，并自动从世界书条目中提取该地点的描述信息注入到上下文中，解决了AI对环境一无所知的问题。

## 近期重要更新 (V13.0 - 核心数据结构重构)

1.  **【核心架构】顶层变量重构**:
    *   **“玩家/世界”分离**: 为了从根本上厘清数据权责，对核心变量 (`[InitVar].txt`) 的顶层结构进行了重构。现在，所有变量被清晰地划分为两大命名空间：
        *   `玩家`: 存放所有与玩家本体相关的、跨越世界的数据（如`本体`属性、`模拟器`状态、`往世道标`）。
        *   `世界`: 存放所有独立的世界“沙盒”。
    *   **世界数据内聚**: 每个独立的世界对象 (`世界.{world_id}`) 现在都包含了自己专属的 `定义`（规则）、`数据库`（物品/技能模板）、`因果之网`（社交关系）和 `角色`（NPC列表）。这确保了不同世界之间数据的完全隔离，完美地体现了“诸天万界”的设定。

2.  **【前端适配】全路径更新**:
    *   为了适应新的数据结构，对前端所有代码 (`store`, `services`, `components`, `views`) 中引用旧变量路径的地方进行了全面审查和更新。
    *   所有对 `store.worldState.角色`、`store.worldState.数据库` 等旧路径的访问，都已被修改为从正确的上下文（如 `store.worldState.玩家.本体` 或 `activeWorld.数据库`）获取数据。

3.  **【健壮性】类型系统同步**:
    *   更新了 `types/index.ts` 中的 `World` 和 `WorldState` 接口，使其与新的 `[InitVar].txt` 结构完全匹配，确保了编译时的类型安全。
    *   废弃了旧的、孤立的 `types/schema.ts` 文件，将所有Zod Schema的定义统一到了世界书规则中，确保了数据源的唯一性。

## 近期重要更新 (V12.0 - 交互优化与稳定性提升)

1.  **【功能】扩展文本交互**:
    *   **物品弹窗**: 继NPC和地点之后，现在主叙事文本中的**物品名称**（如消耗品、奇物、材料等）也会被自动高亮。
    *   **点击详情**: 点击高亮的物品名称，会弹出一个详情卡片 (`DatabaseItemCard.vue`)，展示该物品的类型、能级、描述和具体效果。

2.  **【UI/UX】界面微调**:
    *   **指令队列优化**: 为输入框上方的“指令队列”弹窗增加了符合整体风格的**不透明底色**和边框，并添加了一个**关闭按钮**，提升了可用性。

3.  **【核心】数据健壮性**:
    *   **AI响应规范化**: 在数据处理层新增了一个工具函数 (`tagProcessor.ts`)，用于自动修复和补全AI响应中可能出现的、不规范的 `<thinking>` 和 `<gametxt>` 标签。这提高了数据解析的稳定性，减少了因AI输出格式错误导致的渲染问题。

## 近期重要更新 (V11.0 - 交互增强与UI重构)

1.  **【核心交互】轮盘菜单重构**:
    *   **移除轮盘**: 彻底移除了原有的左右轮盘菜单 (`RadialMenu.vue`)。
    *   **整合至动作面板**: 将所有菜单选项按钮，包括“本体”、“化身”及通用操作，全部整合到输入框上方的 `ActionPanel.vue` 组件中，并分为三行清晰地展示。
    *   **动态禁用**: 所有按钮现在会根据游戏状态（例如，轮回是否正在进行）动态地判断并显示为禁用状态。

2.  **【功能】文本高亮与信息悬浮**:
    *   **实体识别**: 主视图 (`MainView.vue`) 的文本渲染器 (`FormattedTextRenderer.vue`) 现在能够动态识别并高亮文本中出现的 **NPC** 和 **地点** 名称。
    *   **动态着色**: NPC的名称颜色会根据其对玩家的“情感层”关系（亲近感+仰慕度）动态变化，从敌对的红色到友善的绿色，提供了直观的关系反馈。
    *   **点击弹窗**: 点击高亮的NPC或地点名称，会弹出一个详情卡片 (`NpcInfoCard.vue`, `LocationInfoCard.vue`)，展示该实体的详细信息，如生日、相貌、所属地、面积、相对坐标等。
    *   **描边效果**: 为了提高可读性，所有高亮的名称都增加了黑色描边效果。

3.  **【功能】面板交互增强**：
    *   **境界详情弹窗**：现在可以点击“世界详情”面板中的“境界定义”列表项，以弹窗的形式查看该境界的详细描述、解锁系统和晋升需求。
4.  **【核心重构】背包系统 (`InventoryPanel.vue`)**：
    *   **全新布局**：引入了更现代、更易用的“分类侧边栏 + 物品网格”左右分栏布局。
    *   **数据驱动重构**：完全重写了数据加载和处理逻辑，使其与当前 `[InitVar].txt` 中定义的最新数据结构（`角色.背包` 和 `数据库`）兼容。
    *   **UI/UX 优化**：重新设计了物品的展示方式，使其在新的网格布局中更清晰、更美观。
5.  **【UI/UX】界面优化**:
    *   **增高标签栏**: 增加了 `golden-layout` 面板标签的高度，优化了视觉效果和点击体验。
    *   **修复地点弹窗**: 彻底解决了地点详情卡片中“所属”信息无法正确显示的异步加载和数据时序问题。
    *   **扩展通知系统**：
        *   **更全面的覆盖**：现在，当玩家属性（基础潜力、战斗参数等）、世界大事、新NPC登场等关键事件发生时，都会弹出相应的气泡通知。
        *   **交互性增强**：现在可以随时点击通知气泡来手动消除它们。
    *   **修复布局**: 解决了 `MainView.vue` 被重复渲染，导致主视图内容在底部额外显示一次的布局问题。

## 近期重要更新 (V10.0 - 布局持久化 & 稳定性增强)

1.  **【核心功能】布局持久化系统**:
    *   **引入 `LayoutService.ts`**: 新增了一个专门用于处理布局状态的服务，彻底解决了 `golden-layout` 因刷新或重载导致布局丢失的问题。
    *   **手动保存与恢复**: 新系统通过监听面板的创建和销毁事件，实时将完整的 `LayoutConfig` 保存到 `localStorage`。在应用启动时，会主动从 `localStorage` 读取并恢复上一次的布局状态。
    *   **双模式布局**: `LayoutService` 支持“普通模式”和“全屏模式”两套独立的布局记忆，确保在不同显示模式下切换时，用户的个性化布局都能被完美保留和恢复。

2.  **【体验】全屏模式无缝切换**:
    *   **引入 `EventBus.ts`**: 创建了一个全局事件总线，以解耦 `store/ui.ts` 和布局服务之间的依赖。
    *   **状态同步**: 现在，当通过 `store/ui.ts` 中的 `toggleWebFullscreen` 动作切换全屏状态时，会发出一个全局事件，`LayoutService` 监听到该事件后会自动切换并恢复对应的布局。

3.  **【稳定性】修复与重构**:
    *   **修复 `unpinAllPanels` 功能**: 补全了 `DockManagerService.ts` 中 `unpinAllPanels` 方法的实现，确保取消所有面板固定功能可以正常工作。
    *   **服务解耦**: 通过引入事件总线，优化了 `DockManagerService`、`usePanelManager` 和 `LayoutService` 之间的交互逻辑，降低了模块间的耦合度，提升了代码的健壮性。

## 项目结构

*   **/components**: 存放Vue通用组件。
    *   `TopStatusBar.vue`: 顶部状态栏，显示世界时间等核心信息。
    *   `ActionPanel.vue`: **(重构)** 取代了轮盘菜单，现在是所有核心操作的入口。
    *   `DockManager.vue`: 基于 `golden-layout` 的核心布局管理器。
    *   `FormattedTextRenderer.vue`: **(增强)** 负责渲染游戏文本，并实现了NPC和地点的动态高亮与点击交互。
    *   `NpcInfoCard.vue` & `LocationInfoCard.vue`: **(新增)** 用于在弹窗中显示实体信息的卡片组件。
*   **/core**: 包含项目核心加载与初始化逻辑。
*   **/services**: 存放与后端和数据处理相关的服务。
    *   `DockManagerService.ts`: **（重构）** 封装 `golden-layout` 的所有操作。
    *   `LayoutService.ts`: **(新增)** 负责布局的持久化存储与恢复。
    *   `EventBus.ts`: **(新增)** 全局事件总线，用于服务间解耦。
    *   `usePanelManager.ts`: 集中管理所有面板的注册信息和开启逻辑。
    *   `NpcService.ts`: **(增强)** 现在会缓存地点的父级信息，以支持更精确的地点关系查找。
    *   `ContextService.ts`: **(V14.0 重构)** 负责基于用户意图和全局索引，构建发送给AI的精简上下文。
    *   `EntityIndexService.ts`: **(V14.0 新增)** 负责构建和维护全局实体索引。
*   **/store**: 状态管理中心。
*   **/styles**: 存放全局SCSS样式文件。
*   **/types**: **核心类型定义中心**，使用 Zod 定义了整个应用的数据结构，并负责在运行时进行数据校验和转换。
*   `app.vue`: 应用的根组件。
*   `index.ts`: 项目主入口文件。
*   `index.html`: UI的HTML入口。

## 开发规范

*   **类型优先**: 所有核心数据结构都必须在 `/types` 目录中定义清晰的TypeScript接口。
*   **逻辑分离**: 业务逻辑、数据获取和转换应尽可能放在 `store/actions.ts` 和 `store/getters.ts` 中。共享的UI逻辑（如面板管理）应抽象为Composable。
*   **注释清晰**: 所有新添加的文件和复杂逻辑都应有清晰的JSDoc注释。
