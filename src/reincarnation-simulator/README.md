# 轮回模拟器 - 前端界面

本项目是“轮回-诸天万界”世界观的前端UI实现，基于Vue 3、TypeScript和SCSS构建，旨在提供一个沉浸式、数据驱动的交互体验。

## 近期重要更新 (V12.0 - 交互优化与稳定性提升)

1.  **【功能】扩展文本交互**:
    *   **物品弹窗**: 继NPC和地点之后，现在主叙事文本中的**物品名称**（如消耗品、奇物、材料等）也会被自动高亮。
    *   **点击详情**: 点击高亮的物品名称，会弹出一个详情卡片 (`DatabaseItemCard.vue`)，展示该物品的类型、能级、描述和具体效果。

2.  **【UI/UX】界面微调**:
    *   **指令队列优化**: 为输入框上方的“指令队列”弹窗增加了符合整体风格的**不透明底色**和边框，并添加了一个**关闭按钮**，提升了可用性。

3.  **【核心】数据健壮性**:
    *   **AI响应规范化**: 在数据处理层新增了一个工具函数 (`tagProcessor.ts`)，用于自动修复和补全AI响应中可能出现的、不规范的 `<thinking>` 和 `<gametxt>` 标签。这提高了数据解析的稳定性，减少了因AI输出格式错误导致的渲染问题。

## 近期重要更新 (V11.0 - 交互增强与UI重构)

1.  **【核心交互】轮盘菜单重构**:
    *   **移除轮盘**: 彻底移除了原有的左右轮盘菜单 (`RadialMenu.vue`)。
    *   **整合至动作面板**: 将所有菜单选项按钮，包括“本体”、“化身”及通用操作，全部整合到输入框上方的 `ActionPanel.vue` 组件中，并分为三行清晰地展示。
    *   **动态禁用**: 所有按钮现在会根据游戏状态（例如，轮回是否正在进行）动态地判断并显示为禁用状态。

2.  **【功能】文本高亮与信息悬浮**:
    *   **实体识别**: 主视图 (`MainView.vue`) 的文本渲染器 (`FormattedTextRenderer.vue`) 现在能够动态识别并高亮文本中出现的 **NPC** 和 **地点** 名称。
    *   **动态着色**: NPC的名称颜色会根据其对玩家的“情感层”关系（亲近感+仰慕度）动态变化，从敌对的红色到友善的绿色，提供了直观的关系反馈。
    *   **点击弹窗**: 点击高亮的NPC或地点名称，会弹出一个详情卡片 (`NpcInfoCard.vue`, `LocationInfoCard.vue`)，展示该实体的详细信息，如生日、相貌、所属地、面积、相对坐标等。
    *   **描边效果**: 为了提高可读性，所有高亮的名称都增加了黑色描边效果。

3.  **【功能】面板交互增强**：
    *   **境界详情弹窗**：现在可以点击“世界详情”面板中的“境界定义”列表项，以弹窗的形式查看该境界的详细描述、解锁系统和晋升需求。
4.  **【核心重构】背包系统 (`InventoryPanel.vue`)**：
    *   **全新布局**：引入了更现代、更易用的“分类侧边栏 + 物品网格”左右分栏布局。
    *   **数据驱动重构**：完全重写了数据加载和处理逻辑，使其与当前 `[InitVar].txt` 中定义的最新数据结构（`角色.背包` 和 `数据库`）兼容。
    *   **UI/UX 优化**：重新设计了物品的展示方式，使其在新的网格布局中更清晰、更美观。
5.  **【UI/UX】界面优化**:
    *   **增高标签栏**: 增加了 `golden-layout` 面板标签的高度，优化了视觉效果和点击体验。
    *   **修复地点弹窗**: 彻底解决了地点详情卡片中“所属”信息无法正确显示的异步加载和数据时序问题。
    *   **扩展通知系统**：
        *   **更全面的覆盖**：现在，当玩家属性（基础潜力、战斗参数等）、世界大事、新NPC登场等关键事件发生时，都会弹出相应的气泡通知。
        *   **交互性增强**：现在可以随时点击通知气泡来手动消除它们。
    *   **修复布局**: 解决了 `MainView.vue` 被重复渲染，导致主视图内容在底部额外显示一次的布局问题。

## 近期重要更新 (V10.0 - 布局持久化 & 稳定性增强)

1.  **【核心功能】布局持久化系统**:
    *   **引入 `LayoutService.ts`**: 新增了一个专门用于处理布局状态的服务，彻底解决了 `golden-layout` 因刷新或重载导致布局丢失的问题。
    *   **手动保存与恢复**: 新系统通过监听面板的创建和销毁事件，实时将完整的 `LayoutConfig` 保存到 `localStorage`。在应用启动时，会主动从 `localStorage` 读取并恢复上一次的布局状态。
    *   **双模式布局**: `LayoutService` 支持“普通模式”和“全屏模式”两套独立的布局记忆，确保在不同显示模式下切换时，用户的个性化布局都能被完美保留和恢复。

2.  **【体验】全屏模式无缝切换**:
    *   **引入 `EventBus.ts`**: 创建了一个全局事件总线，以解耦 `store/ui.ts` 和布局服务之间的依赖。
    *   **状态同步**: 现在，当通过 `store/ui.ts` 中的 `toggleWebFullscreen` 动作切换全屏状态时，会发出一个全局事件，`LayoutService` 监听到该事件后会自动切换并恢复对应的布局。

3.  **【稳定性】修复与重构**:
    *   **修复 `unpinAllPanels` 功能**: 补全了 `DockManagerService.ts` 中 `unpinAllPanels` 方法的实现，确保取消所有面板固定功能可以正常工作。
    *   **服务解耦**: 通过引入事件总线，优化了 `DockManagerService`、`usePanelManager` 和 `LayoutService` 之间的交互逻辑，降低了模块间的耦合度，提升了代码的健壮性。

## 项目结构

*   **/components**: 存放Vue通用组件。
    *   `TopStatusBar.vue`: 顶部状态栏，显示世界时间等核心信息。
    *   `ActionPanel.vue`: **(重构)** 取代了轮盘菜单，现在是所有核心操作的入口。
    *   `DockManager.vue`: 基于 `golden-layout` 的核心布局管理器。
    *   `FormattedTextRenderer.vue`: **(增强)** 负责渲染游戏文本，并实现了NPC和地点的动态高亮与点击交互。
    *   `NpcInfoCard.vue` & `LocationInfoCard.vue`: **(新增)** 用于在弹窗中显示实体信息的卡片组件。
*   **/core**: 包含项目核心加载与初始化逻辑。
*   **/services**: 存放与后端和数据处理相关的服务。
    *   `DockManagerService.ts`: **（重构）** 封装 `golden-layout` 的所有操作。
    *   `LayoutService.ts`: **(新增)** 负责布局的持久化存储与恢复。
    *   `EventBus.ts`: **(新增)** 全局事件总线，用于服务间解耦。
    *   `usePanelManager.ts`: 集中管理所有面板的注册信息和开启逻辑。
    *   `NpcService.ts`: **(增强)** 现在会缓存地点的父级信息，以支持更精确的地点关系查找。
*   **/store**: 状态管理中心。
*   **/styles**: 存放全局SCSS样式文件。
*   **/types**: **核心类型定义中心**，使用 Zod 定义了整个应用的数据结构，并负责在运行时进行数据校验和转换。
*   `app.vue`: 应用的根组件。
*   `index.ts`: 项目主入口文件。
*   `index.html`: UI的HTML入口。

## 开发规范

*   **类型优先**: 所有核心数据结构都必须在 `/types` 目录中定义清晰的TypeScript接口。
*   **逻辑分离**: 业务逻辑、数据获取和转换应尽可能放在 `store/actions.ts` 和 `store/getters.ts` 中。共享的UI逻辑（如面板管理）应抽象为Composable。
*   **注释清晰**: 所有新添加的文件和复杂逻辑都应有清晰的JSDoc注释。
