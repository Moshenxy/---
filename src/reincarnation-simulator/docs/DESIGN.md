# 轮回模拟器 - 技术设计与架构解析

本文档旨在深入解析“轮回-诸天万界”前端项目的技术架构、数据流和核心逻辑，为后续的开发、维护和功能迭代提供一份清晰的指导蓝图。

## 1. 项目概述

本项目是“轮回-诸天万界”世界观的前端UI实现，基于 **Vue 3**、**TypeScript** 和 **SCSS** 构建。其核心目标是为用户提供一个能够与AI驱动的、动态演化的游戏世界进行深度交互的沉浸式界面。

## 2. 前端架构

前端采用现代化的组件式开发模式，结构清晰，逻辑分离。

### 2.1. 核心技术栈

- **UI框架**: Vue 3 (Composition API)
- **编程语言**: TypeScript
- **样式**: SCSS (BEM-like naming)
- **核心布局**: `dock-spawn-ts` for a flexible, dockable panel-based UI.

### 2.2. 启动流程 (`index.ts` -> `app.vue`)

1.  **入口 (`index.ts`)**:
    - 动态加载 Vue 核心 (`vue-loader.ts`)。
    - 导入全局样式 (`main.scss`)。
    - **异步初始化核心服务**: 通过 `initializeServices()` 函数，特别是 `npcService.initializeWorldAndLocationData()`，在应用挂载前加载必要的非UI数据（如世界和地点信息），这是确保数据可用性的关键前置步骤。
    - 实例化并导出所有单例服务，如 `saveLoadService`, `commandService`, `tavernService`。

2.  **根组件 (`app.vue`)**:
    - **布局核心**: 整合了三栏式布局，包括左侧边栏 (`SidePanel.vue`)、右侧边栏 (`RightSidePanel.vue`) 和中央的核心交互区 (`DockManager.vue`)。
    - **全局组件**: 管理全局模态框（确认、详情、NPC列表）和加载指示器。
    - **数据加载与事件监听**: 在 `onMounted` 生命周期钩子中，通过调用 `store/actions.ts` 中的 `actions.loadAllData()` 和 `actions.initializeEventListeners()` 来获取初始状态并设置监听器，正式启动应用的核心数据循环。
    - **响应式布局**: 监听 `isMobileView` 状态，动态调整布局并强制 `DockManager` 更新，以适应不同屏幕尺寸。

### 2.3. 状态管理 (`/store`)

- **`state.ts`**: 定义了响应式的全局状态树，是所有UI组件的数据来源。
- **`getters.ts`**: 提供了派生状态的计算属性，用于将原始状态转换为UI友好的格式（例如 `combinedNarrative`）。
- **`actions.ts`**: 封装了所有修改状态的业务逻辑，是与后端（酒馆助手）交互、解析数据和更新状态的核心。

## 3. 数据模型与规则

系统的数据交互严格遵循预定义的结构和规则，确保了逻辑的一致性和可预测性。

### 3.1. 核心数据结构 (`[InitVar].txt`)

所有游戏状态都存储在一个巨大的JSON对象中，其核心根节点为：

- **`角色`**: 存放玩家本体 (`{{user}}`) 和所有NPC的数据。
  - **本体**: 拥有跨轮回的永久属性，如 `灵魂本源`, `轮回烙印`, 以及多个分类背包 (`消耗品列表`, `奇物列表` 等)。
  - **化身/NPC**: 拥有当世的临时属性，如 `本世宿命`, `世界专属属性`, 和统一的 `持有物品` 列表。
- **`世界`**: 存放所有独立世界的信息，包括其 `规则` (能级、时间流速)、`状态` (定位、当前时间)、`文明` 和 `力量体系`。
- **`模拟器`**: 控制整个轮回玩法的核心状态机，分为 `准备`, `模拟`, `结算` 三个阶段。

### 3.2. 变量更新规则 (`[系统]变量更新规则.txt`)

前端在与后端交互或内部处理数据时，必须遵守以下核心规则：

- **【黄金规则】**: 所有 `[ [条目列表], "描述" ]` 结构的数组，添加新条目时路径必须以 `[0]` 结尾 (e.g., `_.assign('消耗品列表[0]', ...)`).
- **【白金规则】**: 创建新角色时，必须在单条 `_.assign` 指令中提供其**全部**顶级属性，禁止后续追加。
- **【双向关系】**: 更新角色A对B的关系后，必须同时更新B对A的反向关系。

## 4. 游戏逻辑与AI交互

前端不仅是数据的展示器，更是与AI进行复杂交互的终端。

### 4.1. 核心玩法循环 (`[主]轮回-诸天万界核心规则.txt`)

前端UI需要完整支持以下循环：

1.  **投影**: 用户通过UI选择世界和化身。
2.  **体验**: 用户输入指令，前端发送给AI。AI返回XML格式的响应，前端负责解析并更新UI。
3.  **结算**: 化身死亡或完成终极任务后，AI返回 `<结算>` 模块，前端需展示 `宿命抉择` 选项，并处理玩家的选择。

### 4.2. AI响应格式 (`[系统]世界生成及演化规则.txt`)

AI的响应是一个结构化的XML字符串，前端必须有一个专门的解析器来处理以下核心标签：

- **`<gametxt>`**: 主要的剧情叙事文本，应被渲染在主内容区域。
- **`<UpdateVariable>`**: 包含一系列 `lodash`-style 的指令，用于精确更新前端的全局状态。这是数据同步的核心。
- **`<主世界摘要>` / `<化身世界摘要>`**: 后台世界的事件摘要，应以通知或独立的日志面板形式展示。
- **`<本世历程>`**: 每次行动的结构化日志，是构建游戏历史记录和“往世涟漪”功能的数据源。
- **`<可选化身>` / `<往世涟漪>`**: 在特定游戏阶段出现，前端需要将其解析并渲染成对应的UI界面。

### 4.3. AI决策流程 (`【cot】*.txt`)

理解AI的思考链有助于前端更好地预测和处理其行为：

- **创世流程**: AI会生成包含详细`内容`（如空间实体、历史）和`力量体系`的`<新世界>`描述，同时生成一条只包含核心规则的`_.assign('世界', ...)`指令。前端需要利用这两部分信息来完整地构建和展示一个新世界。
- **身份生成**: AI为每个化身都预设了完整的`本世宿命`（终极任务+命运节点），前端可以利用这些信息为玩家提供命运预览。
- **常规流程**: AI的行为是数据驱动的，前端必须保证将所有`UpdateVariable`指令正确应用，以维持与AI逻辑的一致性。

## 5. 开发建议

1.  **创建专用XML解析服务**: 建议在 `services` 目录下创建一个 `AIResponseParser.ts` 服务，专门负责解析AI返回的XML字符串，将其分发给`store`中的actions进行处理。
2.  **强化类型定义**: 为 `[InitVar].txt` 中定义的所有核心数据结构，在 `/types` 目录下创建对应的TypeScript接口。这能极大地提升代码的健壮性和可维护性。
3.  **实现后台摘要UI**: 为`<主世界摘要>`和`<化身世界摘要>`设计一个非模态的通知系统或一个可停靠的“世界动态”面板，以实现“双线叙事”的沉浸感。
4.  **开发日志系统**: 基于`<本世历程>`标签返回的数据，开发一个功能完善的日志系统，允许玩家回顾历史、查看NPC的后台行动，这对于理解复杂的剧情至关重要。