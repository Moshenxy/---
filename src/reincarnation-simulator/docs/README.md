# 轮回模拟器 - 模块化结构与开发指南

本文档旨在提供对“轮回-诸天万界”前端项目（`reincarnation-simulator`）的模块化结构、核心服务和开发规范的详细说明。

## 一、 顶级目录结构

```
/reincarnation-simulator
├── /assets/         # 存放静态资源，如图片、字体等
├── /components/     # 存放可复用的Vue组件
├── /core/           # 项目核心初始化与加载逻辑
├── /docs/           # 项目文档，如本文件
├── /modules/        # （建议新增）存放大型功能模块的独立封装
├── /services/       # 业务逻辑服务层
├── /store/          # 全局状态管理
├── /styles/         # 全局SCSS样式文件
├── /types/          # TypeScript类型定义
├── /utils/          # 通用工具函数
├── /views/          # （建议新增）存放与特定视图或路由关联的顶层组件
├── app.vue          # Vue应用的根组件
├── index.html       # HTML入口文件
├── index.ts         # TypeScript主入口文件
└── README.md        # 项目概览
```

## 二、 核心模块详解

### 1. `/components` - 可复用组件库

此目录是UI构建的基础，所有不与特定业务逻辑强绑定的通用组件都应放在此处。

-   **/common**: 存放原子级别的通用组件，如自定义按钮、输入框 (`EnhancedInputBox.vue`)、格式化文本渲染器 (`FormattedTextRenderer.vue`) 等。
-   **/controls**: 存放交互控制相关的组件，如轮盘菜单 (`RadialMenu.vue`)。
-   **/modals**: 存放各类全局模态框，如确认框、详情展示框 (`NpcListModal.vue`) 等。
-   **/panels**: **核心功能面板**。存放所有可被 `DockManager` 管理的可停靠面板。每个面板都应是一个独立的功能单元，如角色面板、背包面板等。

### 2. `/core` - 应用初始化核心

此目录负责应用启动时的引导和初始化序列。

-   `vue-loader.ts`: 负责动态加载Vue运行时，并挂载 `app.vue` 根组件到DOM上。这是所有UI渲染的起点。

### 3. `/services` - 业务逻辑服务层

这是连接UI视图与数据状态的桥梁，所有复杂的业务逻辑、与酒馆助手的交互、以及数据处理都应封装在此处。

-   `TavernService.ts`: 封装所有与酒馆助手接口的直接交互，如获取变量、触发命令等。
-   `CommandService.ts`: 解析和执行通过UI输入的特定指令。
-   `DockManagerService.ts`: 对 `dock-spawn-ts` 库的封装，提供统一的API来管理（如打开、关闭、定位）所有的功能面板。
-   `usePanelManager.ts`: **面板管理中枢**。它定义了所有面板的元数据（如标题、对应的Vue组件等），并提供 `openPanel` 方法。这是一个典型的Vue Composable，极大地提高了代码的复用性和可维护性。
-   `NpcService.ts`: 负责处理与NPC相关的数据获取、解析和缓存，为NPC目录等功能提供数据支持。
-   `saveLoadService.ts`: 管理游戏数据的保存与加载逻辑，包括自动保存机制。

### 4. `/store` - 全局状态管理

项目的“单一数据源”，负责管理所有与世界观同步的核心数据。

-   `state.ts`: 定义全局响应式 `store` 对象。这是所有原始数据的存放地，其结构应严格遵守 `[InitVar].txt` 的定义。
-   `actions.ts`: **行为中心**。封装了所有对 `state` 的修改操作。任何需要改变游戏状态的业务逻辑（如处理玩家输入、响应世界事件）都应通过调用这里的 action 来完成。
-   `getters.ts`: **数据派生中枢**。负责从原始的 `state` 中计算和派生出UI组件可以直接使用的数据。例如，将角色背包中的物品ID与数据库中的物品模板组合成完整的物品列表。
-   `ui.ts`: 存放与UI本身相关的状态，如面板的固定状态、全屏模式等，将UI状态与游戏核心数据分离。

### 5. `/styles` - 全局样式与主题

-   `main.scss`: 全局样式入口文件。
-   `/theme`: **“归墟道镜”主题**的核心。`_variables.scss` 定义了所有的颜色、字体、间距等设计变量；`_mixins.scss` 提供可复用的样式代码块（如磨砂玻璃效果）。

### 6. `/types` - TypeScript类型定义

项目的“法典”。此目录下的所有 `*.d.ts` 文件定义了核心数据结构的TypeScript接口，是保证代码健壮性和可维护性的基石。**所有类型定义都必须与 `[InitVar].txt` 和 `[系统]变量更新规则.txt` 保持绝对同步。**

## 三、 开发最佳实践

1.  **数据单向流**:
    -   **视图 (Components)**: 只负责展示由 `store/getters` 提供的数据，并通过调用 `store/actions` 来响应用户交互。
    -   **行为 (Actions)**: 负责执行业务逻辑，并修改 `store/state`。
    -   **状态 (State)**: 状态的变更会通过 `getters` 自动反映到视图上。

2.  **逻辑分层**:
    -   **视图层 (`/components`)**: 保持“干净”，只处理UI展示和用户事件的派发。
    -   **服务层 (`/services`)**: 处理复杂的、可复用的业务逻辑。
    -   **状态层 (`/store`)**: 集中管理应用的所有状态。

3.  **样式规范**:
    -   **新建样式**: 为新的组件或视图创建独立的 `.scss` 文件，并通过 `import './style.scss'` 引入。
    -   **主题优先**: 优先使用 `/styles/theme/_variables.scss` 中定义的设计变量，而不是硬编码颜色、字体大小等。
    -   **高度自适应**: 遵循 `aspect-ratio` 的原则来控制UI的整体高度，避免使用 `vh` 单位。

4.  **模块化开发**:
    -   当开发一个新功能（如“任务系统”）时，建议在 `/modules` 目录下为其创建一个独立的文件夹，将相关的组件、服务和类型定义都放在其中，以实现高内聚、低耦合。

5.  **严格遵守规则**:
    -   所有与游戏变量相关的操作，都必须严格遵循 `[系统]变量更新规则.txt` 中定义的逻辑。
    -   在开发过程中，应频繁参考 `/types` 目录下的类型定义，确保数据的正确性。

通过遵循以上结构和规范，我们可以确保项目在不断迭代和扩展的过程中，依然保持清晰、健壮和高效。