# 日记 (DiaryApp) App 参考文档

本文档详细说明了“日记”App的功能、代码结构、核心数据流和相关文件，为后续的开发和维护提供清晰的指引。

## 1. 功能总览

日记App是游戏内一个至关重要的工具，它不仅是玩家回顾游戏历程的窗口，更是实现AI长期记忆和上下文理解的核心机制。

-   **日志展示**: 自动从世界书读取并按时间倒序展示所有已发生的事件日志。
-   **AI总结**: 提供“小总结”和“大总结”功能，利用AI对不同时间跨度的日志进行归纳，形成短期和长期记忆。
-   **记忆回写**: 允许将AI生成的总结保存回世界书，供AI在后续的交互中参考。
-   **日志重构**: (高级功能) 允许用户在编辑总结后，反向调用AI，用精炼的总结来重构和优化原始的、冗长的日志记录。

## 2. 核心数据流：三层记忆模型

日记App的核心是一个精巧的、自动化的“三层记忆”数据流，旨在为AI提供不同粒度的上下文。

### 2.1. 日志的生成与存储

1.  **AI生成**: 在每次交互后，AI的回复中都会包含一个 `<校园日志>` 块，该块以标准格式记录了当次事件的关键信息（日期、地点、人物、描述、NPC自动化推演等）。
2.  **前端捕获**: [`store/actions.ts`](../store/actions.ts) 中的 `fetchCoreData` 函数会捕获这个 `<校园日志>` 块。
3.  **追加写入**: `fetchCoreData` 会将捕获到的日志块内容，作为一个新条目，追加（Append）到世界书条目 **`校园日志-主`** 和 **`校园日志-辅`** 的末尾。使用 `---` 作为分隔符。

### 2.2. 日志的读取与分层

当用户打开日记App时，会触发 `fetchDiaryEntries` action，执行以下操作：

1.  **读取**: 从世界书读取 **`校园日志-主`** 的全部内容。
2.  **解析**: 将内容按 `---` 分割成独立的日志块，并解析每个块的结构化数据，转换为一个事件对象数组 `allEntries`。
3.  **分层 (核心)**: 将 `allEntries` 数组（已按时间倒序）切割成三部分，存入 `store.diary`：
    -   `displayEntries`: 最新的 `x` 条日志，直接在UI上显示，提供近期细节。
    -   `smallSummaryEntries`: 中间的 `y` 条日志，作为生成“小总结”（短期记忆）的材料。
    -   `largeSummaryEntries`: 最旧的剩余所有日志，作为生成“大总结”（长期记忆）的材料。

### 2.3. AI总结与回写

1.  **生成总结**: 用户点击“生成小/大总结”按钮，触发 `generateDiarySummary` action。
2.  **调用服务**: 该action调用 [`services/diaryService.ts`](../services/diaryService.ts) 中的 `generateSummary` 方法，将对应层级的日志条目（`smallSummaryEntries` 或 `largeSummaryEntries`）发送给AI，并请求其生成总结。
3.  **保存总结**: AI返回总结文本后，用户可点击“保存”，触发 `saveDiarySummaries` action，将总结文本分别写入到世界书条目 **`日记总结-小-主`** 和 **`日记总结-大-主`** 中。

这个流程确保了AI可以通过读取不同的总结条目，快速获取关于游戏近期、中期和长期的核心记忆。

## 3. 相关文件

-   **前端Vue组件**:
    -   `src/campus-card-vue/views/apps/diary/DiaryApp.vue` (主视图)
    -   (可能存在的子组件，如 `LogEntry.vue`, `SummaryView.vue`)
-   **状态管理**:
    -   `src/campus-card-vue/store/actions.ts` (包含所有日记相关的actions)
    -   `src/campus-card-vue/store/state.ts` (定义 `store.diary` 的数据结构)
-   **服务模块**:
    -   `src/campus-card-vue/services/diaryService.ts` (封装调用AI进行总结的逻辑)
-   **世界书规则**:
    -   `src/天华校园世界书/[系统]NPC生活自动化-校园版.txt` (定义 `<校园日志>` 的生成格式)
    -   `src/天华校园世界书/[系统]AI思考链-校园版.txt` (定义AI如何使用三层记忆模型)
-   **世界书数据**:
    -   `校园日志-主` (原始数据源，由前端写入)
    -   `日记总结-小-主` (派生数据，由前端写入)
    -   `日记总结-大-主` (派生数据，由前端写入)