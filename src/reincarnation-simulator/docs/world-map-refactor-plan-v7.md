# 世界沙盘 V7.0 重构方案：“星图”式分层探索模型

## 1. 核心理念

将“世界沙盘”重构为一个“星图”式的交互地图。在此模型中，每一个地理或政治实体都是一个“星辰”（节点），它们之间的从属关系构成了“星轨”（连线）。用户可以像在星际地图中一样，从宏观的星系（顶层疆域）逐级跃迁至微观的行星系（城市、街区），实现真正的、无限层级的世界探索。

## 2. 数据模型演进

我们将完全拥抱 `[系统]世界生成及演化规则.txt]` 中定义的 `V5.0` 空间关系规则，并作出以下调整：

*   **强化 `所属` 字段**: `所属: { ID: string, 类型: string }` 将成为构建层级关系的**唯一依据**。它允许任何实体（如“厨房”）从属于另一个实体（如“面包坊”），实现无限灵活的嵌套。
*   **弃用 `面积` 字段**: 在布局计算中将**彻底忽略** `面积` 字段。
*   **动态节点大小**: 节点的视觉大小（半径）将与其直接子节点的数量成正比（例如，使用 `log(1 + childCount)` 函数来平滑缩放）。这使得子节点越多的节点（如“亚洲”），看起来就越大。
*   **重新定义 `相对坐标`**: `相对坐标` 将不再用于精确的几何定位，而是作为力导向图中的一个“方位提示”，施加一个微弱的、持续的力，引导节点朝其父节点的某个大致方向漂移。`距离` 则影响连接线的初始长度或引力强度。

## 3. 前端架构与功能重构

将创建一个全新的 `world-map` 模块来组织所有相关代码。

### A. 模块目录结构

```
src/reincarnation-simulator/
└── modules/
    └── world-map/
        ├── components/
        │   ├── WorldMapView.vue       # 主视图，承载D3和交互逻辑
        │   ├── NodeRenderer.vue       # 节点渲染组件
        │   ├── LinkRenderer.vue       # 连线渲染组件
        │   ├── MapNavigator.vue       # 导航面包屑 (例如: 世界 > 亚洲 > 中国)
        │   └── NodeDetailPanel.vue    # 单击时显示的详情面板
        ├── services/
        │   ├── WorldMapDataService.ts # 负责数据解析和层级树构建
        │   └── ForceLayoutService.ts  # 负责D3力导向模拟
        ├── store/
        │   └── mapState.ts            # 集中管理地图状态 (当前视图、路径)
        ├── types/
        │   └── index.ts               # 地图相关的所有类型定义
        └── README.md                  # 新模块的说明文档
```

### B. 核心服务重构 (`services`)

*   **`WorldMapDataService.ts`**: 从世界书原始数据中，解析出所有地理实体，并根据 `所属` 关系构建一个完整的、全量的层级树结构。它还会为每个节点计算其 `childCount` 以便后续确定大小。
*   **`ForceLayoutService.ts`**: 接收一组“可见节点”进行D3力导向布局计算。
    *   **施加的力**:
        1.  `forceLink`: 根据父子关系创建引力。
        2.  `forceCollide`: 根据节点的动态大小（基于子节点数量）设定碰撞半径，确保节点不重叠。
        3.  `forceCenter`: 将整个视图的中心拉向画布中央。
        4.  `forcePositioning` (自定义力): 根据 `相对坐标` 中的方位，施加微弱的推力。

### C. 交互逻辑实现 (`components`)

*   **`WorldMapView.vue`**:
    *   **状态管理**: 从 `mapState.ts` 中获取和更新 `currentRootNodeId`（当前视图的根节点ID）。
    *   **数据流**: 根据 `currentRootNodeId` 从 `WorldMapDataService` 筛选出可见节点，传递给 `ForceLayoutService` 计算布局，最后渲染。
    *   **交互处理**:
        *   **双击节点**: 更新 `currentRootNodeId`，实现“钻取”。
        *   **单击节点**: 显示 `NodeDetailPanel`。
        *   **平移与缩放**: 实现画布的自由导航。
*   **`MapNavigator.vue`**: 显示当前的钻取路径（面包屑），并支持点击返回上级。

此方案将AI的职责明确为**定义关系**，将前端的职责明确为**解释关系并进行可视化**，完全符合项目的新构想。