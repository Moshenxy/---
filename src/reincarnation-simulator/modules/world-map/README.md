# 世界沙盘模块 V7.x (World Map Module V7.x)

本模块实现了“世界沙盘”的最新版本，一个高性能、布局精确、可交互的“星图”式世界探索系统。

## 核心理念 (V7.x)

V7.x 版本的核心是将世界沙盘从一个依赖物理模拟的、不确定的“关系图”，彻底重构为一个由数据驱动的、布局精确的“星图”。这意味着：

- **绝对的布局确定性**: 每个“星辰”（空间实体）的位置不再受任何随机因素影响，而是严格根据其在世界书 `自动化规则` 中定义的 `相对坐标`（包含`方位`和`距离`）进行精确渲染。
- **动态的相对视觉**: 无论节点的真实距离是 1 公里还是 1 光年，系统都会动态计算其在当前视图内的相对视觉距离，确保布局既美观又能反映远近关系。
- **高性能的增量渲染**: 渲染引擎已完全重构，采用 D3.js 的数据绑定范式，只更新发生变化的元素，并加入了平滑的过渡动画，极大地提升了性能和视觉流畅度。

## 架构 (V7.x)

### 1. 数据流

1.  **`LorebookService`**: 读取并解析世界书，生成结构化的 `WorldDefinition` 对象。
2.  **`worldMapDataService`**: 将扁平的 `空间实体` 列表，根据 `所属` 关系，构建成一个以 `WORLD_ORIGIN` 为根的 `MapHierarchy` (层级树)。**此服务现在能智能处理只有一个顶级实体的情况**。
3.  **`WorldMapView.vue` (watch `currentRootNode`)**:
    *   **不再使用 `forceLayoutService`**。
    *   创建一个当前根节点的**深拷贝**，以防止因修改坐标而触发无限循环的副作用。
    *   将根节点（或初始视图中的第一个真实节点）定位在画布中心。
    *   调用 **`coordinateService.calculateRelativePositions`**，传入中心节点和所有其他子节点，计算出它们在屏幕上的最终位置。
4.  **`coordinateService` (V7.x 核心)**:
    *   **`calculateRelativePositions`**:
        *   分析所有子节点的“真实距离”，并创建一个动态的 `d3.scaleLinear` 比例尺。
        *   将真实的距离范围 `[min, max]` 映射到一个固定的**视觉距离范围**（如 `[150px, 400px]`）。
        *   结合方位角和计算出的视觉距离，为每个子节点生成精确的 `(x, y)` 坐标。
    *   **健壮的方位解析**: `parseAzimuth` 方法现在能正确处理包含引号和空格的方位字符串，并支持“中”作为特殊方位。
5.  **`WorldMapView.vue` (renderD3)**:
    *   **增量渲染**: 完全移除 `svg.selectAll('*').remove()`，采用 D3 的 `.data().join().enter().update().exit()` 模式来高效地渲染节点、连线和轨道线。
    *   **过渡动画**: 为节点的进入、更新和退出都加入了平滑的 `d3.transition` 动画。
    *   **稳定的颜色**: 调用 **`colorService`**，根据节点 `层级类型` 的哈希值，为其分配一个稳定、唯一的颜色。

### 2. 功能亮点与修复

- **全方位缩放详情弹窗**: `NodeDetailPanel.vue` 现在支持从八个方向自由拖拽边框来改变大小，提供了更灵活的交互体验。
- **动态节点半径**: 节点的视觉大小现在与其直接子节点的数量（`childCount`）动态关联，信息更丰富。
- **面包屑导航修复**: 通过在 `onActivated` 钩子中重置导航路径，彻底解决了重新打开面板时面包屑状态不正确的问题。
- **卡死问题修复**: 通过在 `watch` 回调中使用深拷贝，并移除 `deep: true` 选项，完全杜绝了因副作用导致的无限循环和界面卡死。
- **轨道线渲染修复**: `renderD3` 现在总是以**当前视图的视觉中心节点**为圆心绘制轨道线，确保了视觉的正确性。

### 3. 交互

*   **下钻 (单击)**: 单击拥有子节点的节点，进入下一层级。
*   **详情 (双击)**: 双击任意节点，弹出可自由拖动和缩放的详情面板。
*   **返回**: 点击面包屑导航，返回上级视图。
*   **缩放/平移**: 通过鼠标滚轮和拖拽，自由缩放和平移画布。
*   **搜索**: 点击可拖拽的搜索按钮，快速查找并跳转到指定节点。
