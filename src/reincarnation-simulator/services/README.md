# 服务层

本目录存放与后端（酒馆助手API）、数据处理和核心业务逻辑相关的服务。

## `LorebookService.ts`

封装了与酒馆助手世界书（Lorebook）交互的所有API调用。提供了读取、写入、追加和查找条目的功能。

## `WorldUpdateService.ts`

**核心功能**: 专用于解析和应用 `<主世界修改>` 和 `<化身世界修改>` 标签中的纯文本指令，实现对世界书（Lorebook）条目内容的动态、增量更新。

**工作流程**:

1.  **接收指令**: 从 `actions.ts` 接收到包含修改指令的文本块和目标世界书条目名称（例如 "主世界"）。
2.  **CST解析**: 使用 `yaml` 库的 `parseDocument()` 方法将目标世界书的文本内容解析为一个具体的语法树（CST）。这确保了所有的原始格式，包括缩进、注释和多行字符串风格，都在内存中得到保留。
3.  **应用指令**:
    *   通过正则表达式逐条解析指令的类型（`替换`, `添加 到`, `从...中移除`）、目标路径和内容。
    *   使用 `doc.setIn()`、`doc.getIn()`、`collection.add()` 和 `collection.delete()` 等 CST 方法来安全地修改文档对象。
    *   **路径创建**: `doc.setIn()` 会在路径不存在时自动创建所需的键和结构。
    *   **多项目添加**: 当“添加”指令的内容是一个数组时，服务会遍历该数组并逐项添加，而不是将整个数组作为一个元素添加，从而确保了正确的列表结构。
    *   **精确删除**: 使用 `lodash.isEqual` 进行深度比较，确保能精确匹配并移除目标对象。
4.  **序列化与写回**: 调用 `doc.toString()` 将修改后的CST序列化回文本字符串，该字符串将完美保留所有未被修改部分的原始格式。最后，调用 `LorebookService` 将其写回世界书。

**设计亮点**:

*   **格式保真**: 通过操作CST而不是纯文本或普通JS对象，实现了对原始格式（特别是复杂的缩进和多行字符串）的最高保真度。
*   **健壮性**: 结合了YAML解析的结构化优势和文本操作的灵活性，能够处理不存在的路径、多项目添加和复杂的对象操作。
*   **模块化**: 将复杂的解析和更新逻辑从 `actions.ts` 中完全分离，使代码结构更清晰，更易于维护。

## 其他服务

*   **`CommandService.ts`**: 管理发送给AI的指令队列。
*   **`ConfirmationService.ts`**: 提供全局确认对话框服务。
*   **`DetailModalService.ts`**: 提供全局详情弹窗服务。
*   **`DockManagerService.ts`**: 封装 `dock-spawn-ts` 的所有操作，提供打开、管理面板的接口。
*   **`saveLoadService.ts`**: 处理状态的保存和加载。
*   **`tavern.ts`**: 封装与酒馆核心API的交互。
*   **`WorkflowService.ts`**: 管理不同阶段（如创世、身份选择、常规游戏）的思考链（CoT）切换。
