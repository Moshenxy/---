# 综漫-春物：青春恋爱模拟器 (Youth Rom-Com Simulator)

> “青春是一场谎言，一种罪恶。” —— 比企谷八幡

欢迎来到 **综漫-春物** 世界模拟器。这是一个深度定制的、基于《我的青春恋爱物语果然有问题》（Oregairu）世界观的沉浸式交互项目。在这里，你不仅是观察者，更是这个充满微妙人际关系与青春烦恼世界中的变数。

## 📖 项目简介

本项目旨在构建一个高度拟真的“千叶市”，还原《春物》中那细腻而纠结的青春氛围。不同于普通的文字游戏，本系统引入了复杂的数值模型和心理博弈机制，让每一个 NPC 都拥有独立的“灵魂”。

**核心特色：**

* **沉浸式千叶**: 从总武高的教室到家庭餐厅，从海边的公园到繁华的千叶站，所有地点都拥有详尽的设定与层级关系。
* **深度心理博弈**: 引入“心理健康”、“核心动机”和“三轴关系”系统，NPC 的行为不再是简单的脚本，而是由其内在逻辑驱动。
* **综漫联动**: 在主线之外，世界中还隐藏着来自其他日常系动漫（如《路人女主》、《中二病》等）的彩蛋与角色，等待你去发现。

## 🧩 核心系统详解

### 1. 「机会成本」驱动的时间系统 (AP System)

我们废除了由AI判断场景完结的模糊时间机制，引入了更具策略性的**行动点（AP）**系统。

* **八大时间片段**: 每一天被划分为“早晨(2AP)”、“上学路(1AP)”、“午前(2AP)”、“午休(3AP)”、“午后(2AP)”、“放学后(5AP)”、“傍晚(3AP)”、“夜(3AP)”这8个片段。
* **AP的本质**: AP代表玩家在该时间片段内可以做出**“重大决策”**的机会次数。AP耗尽，时间片段将自动推进。
* **AP消耗规则**:
  * **自由行动 (0 AP)**: 在一个场景内的所有连续对话、观察、思考均不消耗AP，鼓励深度角色扮演。
  * **重大行动 (AI裁定)**: 玩家的行动意图（如移动、活动）会被发送给AI，由AI在单次响应中，根据其对行动“叙事重要性”和“预估耗时”的理解，动态裁定1-4点的AP消耗，并直接在变量更新中扣除。

### 2. 「动态场景特质」系统 (Dynamic Scene Traits)

为了让地点变得“鲜活”，我们为“空间实体”引入了动态的“场景特质”。

* **地点的性格**: 地点不再是静态的背景板，而是拥有自己的“性格”。例如，“侍奉部活动室”在不同条件下，可能会激活“静谧的红茶时光”或“女王的审判席”等不同特质。
* **AI的导演提示**: 这些特质会包含对AI的明确指令（如“在此地进行【观察】检定+1修正”），前端会在构建上下文时，将当前已激活的特质发送给AI，作为其叙事和判定的最高优先级依据。

### 3. 三轴关系系统 (The Trinity of Relationships)

我们摒弃了单一的“好感度”，采用三个维度来立体地描述人际关系：

* **亲密度 (Affinity)**: 情感上的距离。从“陌路”到“融合”，决定了角色愿不愿意与你在一起。
* **支配度 (Dominance)**: 权力与地位的角力。从“反抗”到“傀儡”，决定了谁在关系中占据主导。
* **信赖度 (Trust)**: 信任与默契。从“背叛”到“灵魂同步”，决定了角色是否愿意将后背交给你。

### 4. 内在世界与心理健康

每个角色都有一个动态的“内在世界”：

* **心理健康 (Sanity)**: 类似 HP 的核心资源。社交失败、压力过大都会导致 SAN 值下降，进而引发“承压”、“紊乱”甚至“崩溃”状态。
* **核心动机 (Drives)**: 生存、享乐、权力、关系、意义。这五大动机决定了角色的行为逻辑和决策倾向。
* **恐惧创伤**: 每个角色内心深处的伤痕（如雪乃的“被孤立”、八幡的“自爆”），触碰这些伤痕会引发剧烈的反应。

### 5. 命运卡牌系统 (Destiny Cards)

系统每隔 1 天会进行一次“命运抽卡”，生成随机的事件、任务或新角色。

* **卡牌类型**: 包括任务卡、角色卡、事件卡、灾难卡等。
* **动态演化**: 卡牌的生成受到当前时间、地点、天气以及角色状态的加权影响。例如，情人节期间“事件卡”的权重会大幅提升。

### 6. 空间实体系统 (Spatial Entities)

世界由一系列具有层级关系的“空间实体”构成：

* **层级化**: 城市 -> 区域 -> 建筑 -> 房间。
* **详情互动**: 在“众生名录”中，你可以点击角色的位置，查看该地点的详细描述、面积和所属关系。

## 🎭 主要角色

* **比企谷八幡**: 拥有“死鱼眼”的腐朽高中生，擅长通过伤害自己来解决问题。
* **雪之下雪乃**: 侍奉部部长，完美主义者，以“绝对正确”为武器武装自己的孤高少女。
* **由比滨结衣**: 善于迎合气氛的温柔少女，侍奉部的润滑剂。
* **一色彩羽**: 拥有“小恶魔”属性的后辈，精于算计但又有着可爱的一面。
* **（玩家）**: 你将作为一名转学生或原住民介入这个世界，你的每一个选择都可能引发蝴蝶效应。

## 🎮 操作指南

### 界面功能

* **主视图**: 显示当前的剧情文本和场景描述。
* **众生名录**:
  * 查看所有已登场角色的列表。
  * 点击角色可查看其【档案】、【权能】（属性/技能）和【因果】（物品/关系/记忆）。
  * **点击角色位置**: 弹出该地点的详细信息卡片。
* **输入框**: 输入你的行动指令。建议使用自然语言描述你的动作和对话（如：“我走向雪之下，递给她一罐 MAX 咖啡”）。

### 交互建议

* **不要试图“口胡”**: 系统拥有严格的合理性审查机制。强行描述不合逻辑的结果（如“我一句话就让雪乃爱上了我”）会被系统无情驳回并施加惩罚。
* **关注心理状态**: 在 NPC 心理健康低下的状态下，请谨慎行事，错误的对话可能导致关系破裂。
* **利用环境**: 时间、天气和地点都会影响检定的成功率。

---

## 📅 近期重要更新 (Changelog)

### V28.0 - 记忆系统与上下文优化

1. **【核心架构】重构记忆系统以优化Token消耗**:
    * **问题定位**: 识别出旧记忆系统存在“广播式”和“检索式”两套并行机制，导致向AI注入了大量冗余的记忆上下文，造成了严重的Token浪费。
    * **架构重组**: 废除了低效的、基于日记的“广播系统”，将 `MemoryService.ts` 的职责重构为专门处理AI响应中的 `<导演场记>`。
    * **智能分层**: 新的 `MemoryService` 会自动将 `<导演场记>` 的内容，根据时效性和重要性，拆分为“瞬时（锚点/完成度）”、“短期（NPC/BBS）”和“长期（导演意图）”三个结构化层级，并分别写入独立的世界书条目。
    * **UI对接**: 将前端的“记忆系统”配置面板与新的分层处理服务对接，使其能够控制场记的拆分粒度，实现了更精准、更高效的上下文管理。

### V27.0 - UI/UX: “未来预言”面板重构

1. **【UI/UX】“未来预言”面板重构为日历视图**:
    * **全新布局**: 将“未来预言”面板从垂直时间线列表，重构为更直观、更具沉浸感的月度日历视图。
    * **动态加载**: 日历现在能够自动加载所有`[数据]主线剧情*.json`文件，并根据每个剧情阶段的`触发条件`中定义的日期，将其准确地显示在日历的对应位置。
    * **交互优化**:
        * **月份切换**: 支持通过按钮切换上一个月和下一个月，方便玩家浏览长线剧情。
        * **详情弹窗**: 点击日历中的任意剧情事件，会弹出一个模态窗口，详细展示该事件的“阶段背景”、“关键人物”、“关键地点”、“关键道具”和“关键情节”，让玩家能提前对未来做好规划。

### V25.0 - 叙事节奏与UI体验重构

1. **【核心机制】引入“时间片段”系统**:
    * **废除精确时间**: 彻底移除了精确到时分秒的时间系统，改为使用更符合叙事节奏的8个“时间片段”（如“放学后”、“深夜”）来驱动世界。
    * **场景驱动**: 时间的推进不再由固定的行动点消耗决定，而是由AI根据当前“场景故事”是否完整来判断，赋予了玩家在每个场景中进行深入、连续交互的自由。
    * **规则同步**: 创建了 `[系统]时间片段与行动轮规则.txt` 文件，并全面更新了 `变量结构`、`mvu_update规则` 和 `COT思考链`，以完全适配新的时间系统。

2. **【日志系统】“日记”与“周记”重构**:
    * **概念统一**: 将项目中所有“本世历程”的概念，在规则、代码和UI层面完全统一为“日记”，使其功能更直观。
    * **引入周记系统**: 设计并实现了“周记”的生成和处理机制。系统现在会自动将10篇日记提炼总结为一篇`<周记>`，并进行归档。
    * **数据持久化**: 新增“日记-禁开”世界书条目，用于永久备份所有历史日记，确保数据的完整性和可追溯性。

3. **【UI/UX】命运卡牌面板重构**:
    * **全新布局**: 将命运卡牌面板从简单的信息罗列，重构为更具交互性的“左侧列表，右侧大卡牌”布局。
    * **视觉升级**: 创建了独立的 `DestinyCard.vue` 组件，为不同类型和等级的卡牌增加了专属的颜色主题、辉光和动画特效，极大地提升了卡牌的视觉表现力。
    * **交互优化**: 增加了搜索和按类型筛选的功能，并修复了多个与数据展示相关的bug。
3. **【UI/UX】命运卡牌面板重构**:
    * **界面分层**: 将原有的单一卡牌面板重构为“卡池”和“背包”两个独立的标签页，使界面功能更清晰。
    * **卡池增强**: 在“卡池”视图中，新增了各类卡牌数量的实时统计功能，让玩家能更直观地了解世界中潜在的可能性。
    * **背包实现**: 新增了“背包”视图，用于展示玩家通过事件或奖励获得的专属卡牌。

4. **【前端代码】大规模重构与清理**:
    * **状态与类型统一**: 全面重构了 `store`、`services` 和 `types`，使前端数据流完全适配新的“日记”和“时间片段”系统。
    * **组件修复与优化**: 修复了多个面板（如 `SaveLoadPanel`, `DiaryPanel`, `ReincarnationPanel`）因重构而产生的bug，并移除了“轮回模拟器”旧项目的残留代码。

### V24.0 - “前端主导规则”架构重构

1. **【核心架构】规则引擎前置**:
    * **重构上下文服务 (`ContextService.ts`)**: 将原本由AI负责的剧情调度、日历事件判断、抽卡时机提醒、乃至视觉渲染等“物理规则”逻辑，全部迁移到前端的 `ContextService` 中。
    * **AI职责变更**: AI（天衍）现在是纯粹的“响应式叙事引擎”，它不再计算规则，而是完全依赖前端在每次交互时注入的、带有明确指导的`<world_context>`来进行创作。
    * **COT同步更新**: 大幅修改了 `【cot】必要关键cot.txt`，要求AI从`<world_context>`标签中解析所有世界状态，并优先采纳前端注入的剧情、事件和渲染描述。

2. **【前端功能】上下文注入系统**:
    * **主线预告 (`潜在主线剧情`)**: `ContextService` 现在会读取世界书，并向上下文中注入未来3天内即将发生的主线剧情的**完整大纲**，包含倒计时和明确的铺垫/触发指令。
    * **日历与事件 (`近期事件`, `可用随机事件`)**: 自动注入未来几天的日历事件和与当前场景角色相关的随机/支线剧情，为AI提供丰富的叙事素材。
    * **视觉渲染 (`渲染描述`)**: 新增 `ClothingService.ts`，它会根据角色、场景、季节，从世界书的`服装库`中智能匹配着装，并将生成的生动描述直接注入到角色数据中。
    * **系统指令 (`系统指令`)**: 新增了明确的指令通道，例如，前端会在抽卡时间到达时，自动在上下文中加入“请立即抽卡”的指令。

3. **【开发工具】调试面板集成**:
    * **新增调试服务 (`DebugService.ts`)**: 用于在前端实时监控世界书的读取状态和发送给AI的上下文。
    * **新增调试面板 (`DebugPanel.vue`)**: 创建了一个新的UI面板，可以直观地看到 `[数据]主线剧情`、`日历`、`服装库` 等核心世界书的读取状态，以及每一轮发送给AI的完整`stat_data`，极大地提升了开发和调试效率。

4. **【修复】启动错误**:
    * **清理遗留代码**: 彻底移除了“轮回模拟器”项目残留的、对不存在的`模拟器`属性的错误引用，解决了应用在生产构建后无法启动的根本问题。

### V22.0 - 空间实体与交互优化

1. **【核心重构】空间实体系统 (`Spatial Entities`)**:
    * 废弃了简单的字符串位置，引入了结构化的“空间实体”对象。
    * 支持层级关系（所属）、面积、相对坐标等丰富属性。
    * 适配了 Zod Schema，允许动态添加新地点。
2. **【UI交互】地点详情弹窗**:
    * 在“众生名录”中，点击角色位置名称现在会弹出一个 `LocationInfoCard`。
    * 修复了数据获取逻辑，使其能正确从扁平化的 `空间实体` 存储中读取数据。
3. **【修复】众生名录显示**:
    * 移除了失效的“世界筛选”功能，现在默认显示所有已登场角色。
    * 修复了“向羽”等新角色无法在列表中显示的问题。

### V21.0 - “众生名录”重构与数据结构适配

1. **【核心重构】众生名录 (`NpcDirectoryPanel.vue`)**:
    * **重构数据服务 (`NpcService.ts`)**: 彻底重写了`NpcService`，使其能够正确解析和处理来自`综漫-春物`世界观的扁平化`角色列表`数据结构。
    * **修复关系显示 (`RelationsDisplay.vue`)**: 修复了关系查找逻辑，现在能够正确处理嵌套的关系对象，并能双向展示NPC之间的人际关系。
    * **UI适配与优化**: 全面调整了“众生名录”中的所有组件 (`NpcArchiveTab`, `NpcPowerTab`, `NpcCauseTab`)，使其能够正确展示新数据结构下的角色档案、属性、技能、记忆和物品栏。

### V19.0 - 交互体验优化

1. **【核心交互】详情弹窗内联化**:
    * **弹窗组件升级**: 重构了点击正文中的NPC名称时的交互逻辑。现在，弹出的详情窗口将直接渲染“众生名录”中使用的、功能更完整的 `NpcDetailDisplay.vue` 组件。

### V18.0 - AI思考链重构与数据自检闭环

1. **【核心·AI思考】引入“逻辑内核+人格化外壳”COT模型**:
    * **流程重构**: 彻底重构了 `【cot】天衍之心.txt`，将原有的九阶线性流程，优化为更精简、更高效的“七步执行清单”。
    * **人格注入**: 在纯逻辑思考链的末尾，新增了【天衍锐评】阶段。

2. **【核心·数据流】实现“天道回溯”数据自检闭环**:
    * **自我稽查**: 新的COT【步骤1：数据自检】将强制AI优先审查这个`<previous_patch>`，检查自己上一轮的变量更新是否存在逻辑错误。

## 📂 项目结构与文件功能

### 核心目录

* `src/综漫-春物/`: **世界观核心数据库 (The Bible)**。包含所有设定、规则、数据模板和 Prompt。
  * `[initvar].txt`: 世界初始状态定义。
  * `[mvu_update]变量更新规则.txt`: 指导 AI 如何通过 JSON Patch 更新变量。
  * `[系统]*.txt`: 定义系统的运行逻辑（如 NPC 自动化、认知隔离、合理性审查）。
  * `[数据]*.json`: 静态资源库（剧情、服装、日历）。
* `src/youth-romcom-simulator/`: **前端应用源码**。
  * `components/`: Vue 通用组件。
    * `common/`: 共享组件，如 `NpcDetailDisplay` (NPC详情), `LocationInfoCard` (地点卡片)。
    * `panels/`: 各大功能面板，如 `NpcDirectoryPanel` (众生名录)。
  * `services/`: 业务逻辑层。
    * `NpcService.ts`: 负责 NPC 数据的获取、过滤和处理。
    * `ContextService.ts`: **【核心】** 负责在与AI交互前，从世界书读取数据（主线、日历、随机剧情等），构建一个包含明确指导的、用于驱动AI叙事的精简上下文。
    * `ClothingService.ts`: **【新增】** 负责根据角色和情景，从服装库生成动态的视觉渲染描述。
    * `DebugService.ts`: **【新增】** 为新集成的调试面板提供数据支持。
    * `EntityIndexService.ts`: 全局实体索引，用于快速查找。
  * `store/`: 状态管理中心。
  * `types/`: TypeScript 类型定义。

### 开发规范简述

* **类型优先**: 所有核心数据结构都必须在 `/types` 目录中定义清晰的 TypeScript 接口。
* **MVU 架构**: 前端只负责 View (渲染) 和 Model (状态存储)，Update (逻辑运算) 全部交由后端 AI 处理。
* **Zod 校验**: 运行时数据必须通过 `变量结构.txt` 中定义的 Zod Schema 校验，否则会被拒绝更新。

---
*Project Youth Rom-Com Simulator © 2023-2026*

---

## 🚀 V26.0 - “五线谱”情景驱动模型重构

本次更新是项目历史上最大规模的一次底层重构，其核心目标是将叙事引擎从“事件驱动”升级为“情景驱动”，赋予AI更强大的导演能力。

### 1. 数据层：引入“五线谱”模型

我们对主线剧情的数据结构（`[数据]主线剧情*.json`）进行了彻底革新，引入了“五线谱”模型。现在，每一个剧情**阶段 (`stage`)** 都包含以下五个核心要素：

1. **`key_characters` (关键人物)**: 定义该场景的核心角色。
2. **`key_locations` (关键地点)**: 定义该场景必须发生的地点。
3. **`key_items` (关键物品)**: 定义该场景中必须被使用或提及的核心道具。
4. **`scene_modifiers` (场景修饰符)**: 定义该场景的氛围、环境和特殊状态，是给AI的“氛围剧本”。
5. **`key_points` (关键情节)**: 定义该场景必须完成的核心叙事任务。

这个模型确保了AI在执行剧情时，能够得到一个包含“谁、在哪、用什么、什么氛围、做什么”的完整情景，从而进行更生动、更具沉浸感的演绎。

### 2. 服务层：`ContextService` 全面升级

`ContextService.ts` 的 `buildLeanContext` 方法已完全重构，以适配“五线谱”模型：

* **完整情景注入**: 无论是“可触发主线”还是“未来主线预告”，现在都会向AI注入包含上述五要素的**完整事件阶段数据**，而不是经过删减的摘要。这确保了AI拥有进行演绎或铺垫所需的全部信息。
* **系统指令注入**: 新增了独立的“系统事件”处理逻辑。现在，服务会检查 `命运卡牌系统.下次抽卡时间`，并在条件满足时，向上下文中注入明确的 `【触发抽卡】` 指令，确保了系统级事件与剧情事件并行不悖。

### 3. AI思维层：COT同步强化

`【cot】必要关键cot.txt` 也进行了同步升级，以强制AI正确地消费新的数据模型：

* **强制情景构筑**: 在`【步骤2.3：脉络洞察】`中加入了新规则，强制要求AI在构思剧情时，必须优先利用接收到的`关键地点`、`关键物品`和`场景修饰符`。
* **深化NPC反应**: 在`【步骤5：NPC自主反应推演】`中，将NPC的`恐惧创伤`和`属性`（尤其是负面修正值）与其潜意识的微动作进行了强绑定，使NPC的行为更加立体，更符合其内在设定。
