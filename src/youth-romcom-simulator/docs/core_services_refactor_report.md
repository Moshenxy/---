# 核心服务重构最终报告

本文档是对近期进行的一系列核心服务重构工作的最终总结。这些修改旨在解决上下文构建、记忆检索、指令发送和日志处理中的多个关键问题，以提升系统的稳定性、智能性和叙事连贯性。

## 一. 记忆与上下文 (`ContextService` & `MemoryRetrievalService`)

这是本次重构的核心，旨在解决上下文信息不完整、不准确以及Token浪费的问题。

### 1. 记忆检索 (`MemoryRetrievalService`) 的核心重构

-   **问题**: 旧的实现存在两大核心缺陷：1. 试图在只有实体名称的日记文本中匹配实体ID，导致检索失败。2. 日期查询与内容查询是互斥的，无法实现“先按日期筛选，再在结果中按内容检索”的递进逻辑。
-   **解决方案**:
    -   **反转匹配逻辑**: 创建了一个 `entityIdToNameMap` (ID到名称的映射索引)，在评分时，通过遍历这个索引，用**实体名称**去匹配日记文本，从根本上解决了ID与名称不匹配的问题。
    -   **实现递进式筛选**: 彻底重构了 `getRelevantMemories` 方法，以实现“日期优先”的递进式筛选逻辑。
        a. **日期初筛**: 如果接收到 `dateFilter` 函数，则首先用它筛选出一个“日期候选集”。
        b. **内容精筛**: 接着，**只在这个候选集上**，根据 `combinedInput` 中的关键词进行相关性评分。
        c. **智能降级返回**: 如果内容精筛有结果，则返回得分最高的；如果内容精筛无果，但日期初筛有结果，则直接返回日期初筛的全部结果，确保了只要日期匹配就一定有返回。如果连日期过滤器都没有，则执行全局相关性搜索。

### 2. 上下文构建 (`ContextService`) 的全面增强

-   **问题**: 指令发送重复、日期解析能力弱、缺乏上文关联。
-   **解决方案**:
    -   **上下文关联**: `buildLeanContext` 现在会接收上一轮的 `gametxt` 内容，并将其与用户的本轮输入合并为 `combinedInput`。这个组合输入被同时用于日期解析和实体提取，确保了对上下文的全面理解。
    -   **智能日期解析**: 完全重构了 `parseRelativeDate` 方法。它现在能通过正则表达式和逻辑判断，理解多种复杂的自然语言时间表述（如“三天前”、“上上周”、“4月的时候”、“下旬”等），并返回一个**日期过滤函数** `(date: string) => boolean`。
    -   **记忆注入修复**: 修复了 `buildMemoryContext` 方法，使其能正确接收日期过滤函数，并调用 `MemoryRetrievalService` 实现递进式筛选。同时，通过区分 `指定日期记忆` 和 `相关记忆` 模块，为AI提供了更清晰的上下文结构。
    -   **指令状态化**: 为抽卡指令的发送逻辑增加了状态机，彻底解决了重复发送指令的BUG。

## 二. 日志与日历系统 (`DiarySynthesisService` & `CalendarService`)

### 1. 日记与周刊合成 (`DiarySynthesisService`)

-   **问题**: 旧的日记合成逻辑依赖于日期变化，但由于调用时机问题，该条件永不满足，导致功能完全失效。
-   **解决方案**:
    -   **日记合成重构**: 彻底重写了 `getSynthesisRequest` 方法。不再依赖于日期变化，而是引入了一个 `processedDatesForDiary` (已处理日期集合) 的状态。该方法现在会查找所有日期**早于当前游戏日期**且**未被处理**的日记片段，然后一次性收集最早的那个“待办日期”的所有片段，生成合成请求。
    -   **日志归档机制确认**: 确认了“日记片段”的归档逻辑位于 `LogSyncService` 中，在AI成功合成一篇新《日记》后被触发，形成了“请求-合成-同步-归档”的完整闭环。

### 2. 日历系统 (`CalendarService`)

-   **问题**: 旧的 `[数据]日历生成器.json` 将规则和数据耦合在一起，且规则是写给AI看的自然语言，不可靠且浪费资源。
-   **解决方案**:
    -   **职责分离**: 创建了新的 `CalendarService.ts`，将日历生成的职责完全从AI转移到前端代码中。
    -   **数据结构化**: 将旧文件拆分为 `[数据]日历-固定事件.json`, `[数据]日历-随机事件.json`, `[数据]日历-跨界事件.json` 三个纯数据文件，并扩充了内容。
    -   **前端主导生成**: `CalendarService` 现在负责读取这些数据文件和主线剧情，按照“主线/固定并行 -> 随机/跨界填充空白”的图层逻辑，在前端生成一个完整的、结构化的日历对象。
    -   **上下文注入**: `ContextService` 不再解析日历规则，而是直接调用 `CalendarService` 获取结果并注入上下文。

## 三. 服装系统 (`[数据]服装风格指南.json` & `ContextService`)

-   **问题**: 旧的 `[数据]服装库.json` 结构扁平，与角色关联弱，扩展性差。
-   **解决方案**:
    -   **理念升级**: 废弃了“衣物列表”的思路，采用“**角色穿搭风格指南**”的新理念。
    -   **创建风格指南**: 创建了独立的 `[数据]服装风格指南.json` 文件。该文件为每个角色，在“通用偏好”、“季节偏好”、“天气应对”、“特殊情境”四个维度下，提供了抽象的、指导性的风格描述。
    -   **前端动态注入**: `ContextService` 的 `buildCharacterContext` 方法被重构。它现在会读取风格指南，并根据当前情境（季节、天气），**选择性地**将最相关的风格描述（如“通用偏好”+“冬季偏好”+“雪天应对”）动态注入到要发送给AI的角色数据中的 `服装风格` 属性下。
    -   **AI创意主导**: AI不再接收具体的衣物描述，而是接收这些“风格规则”，并被COT（思考链）指导去基于角色的基础衣着和这些规则，进行二次创意和细节描写。

通过以上一系列的修复和重构，项目的核心数据处理服务现在处于一个逻辑自洽、功能健壮且协同良好的状态。