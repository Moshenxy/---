# 架构文档：V3 精简上下文系统 (Lean Context System)

## 1. 设计哲学：从“投喂”到“精准滴灌”

V3上下文系统的核心设计哲学，是**将AI从一个需要自行理解和处理海量信息的“思考者”，转变为一个响应精准、结构化指令的“执行者”**。

我们不再将庞杂的原始数据（如完整的历史日志、全量角色卡）直接“投喂”给AI，而是通过一系列前端服务，将这些数据预处理、分析、筛选、并最终组装成一份高度精简、目标明确的“导演文件夹”（`stat_data`），再发送给AI。

这种模式带来了三大核心优势：
1.  **性能提升**: 大幅减少了每次请求的Token数量，降低了API成本和响应延迟。
2.  **稳定性增强**: AI的任务变得更纯粹、更明确，减少了因理解偏差或“自由发挥”而导致的逻辑错误和剧情崩坏。
3.  **可维护性提高**: 复杂的逻辑（如主线触发、日志合成）被前置到可读、可维护的前端TypeScript服务中，而不是隐藏在难以调试的AI提示词里。

## 2. 核心服务：`ContextService.ts`

`ContextService.ts` 是整个系统的“中央厨房”，其核心方法 `buildLeanContext` 负责在每次用户交互时，动态构建发送给AI的上下文。

该方法会依次调用其他服务，组装出两大核心上下文对象：`sceneContext` (当前场景) 和 `worldContext` (世界规则与动态)。最终发送给AI的是这两个对象的组合。

## 3. 上下文内容详解

以下是 `ContextService.ts` 发送给AI的 `stat_data` 中，各个关键字段的详细功能说明：

### 3.1. `当前场景` (Scene Context)

提供最直接的“五感”信息，是AI进行基础场景描写的依据。

*   **`地点`**: `string` - 当前场景的名称，如“侍奉部活动室”。
*   **`时间`**: `string` - 格式化的完整时间，如“2013-04-16 放学后”。
*   **`天气`**: `string` - 当前天气，如“晴天”。
*   **`氛围`**: `string` - 当前地点的“场景特质”，如“静谧的红茶时光, 女王的审判席”。AI被要求将这些特质作为氛围描写的核心。

### 3.2. `主角` (Protagonist)

直接注入**玩家角色**的完整对象。这与 `在场人物` 分离，是为了让AI始终明确操作的主体是谁。

### 3.3. `在场人物` & `非在场人物摘要`

*   **`在场人物`**: `Record<string, Npc>`
    *   **策略**: 只包含**当前场景内**的所有NPC的**完整数据**。
    *   **优化**: 每个在场NPC对象都被 `ClothingService` 动态注入了一个 `渲染描述` 字段，AI可以直接使用这些生动的文字来描写角色外观，无需自行构思。

*   **`非在场人物摘要`**: `Record<string, object>`
    *   **策略**: 对于不在当前场景的NPC，仅提供一个包含“名称、身份、位置、核心特质”的摘要对象。
    *   **优化**: 避免了发送全量NPC数据，这是上下文精简的核心之一。

### 3.4. `关系网络` (Relationship Context)

*   **策略**: 仅提取并发送**在场角色之间**的关系数据。
*   **优化**: 避免了发送整个庞大的N x N关系矩阵。AI只需关心当前场景下的社交动态。

### 3.5. `导演指令` (Directive Context) - **【系统大脑】**

这是整个上下文系统中最核心、最重要的部分。它将前端服务计算出的“指令”直接下达给AI。

*   **`待触发主线`**:
    *   **来源**: `StorylineService.ts` 根据当前世界状态判断出的、**唯一一个**可触发的主线事件。
    *   **内容**: 包含该事件阶段的完整“五线谱”剧本（背景、关键人物、地点、道具、情节、NPC剧本等）。
    *   **作用**: AI被**强制要求**在本回合或未来几个回合内，严格按照此剧本进行演绎。

*   **`未来主线预告`**:
    *   **来源**: `StorylineService.ts` 提供的、按时间顺序排列的、**后续最多3个**未完成的主线事件大纲。
    *   **作用**: **仅供AI参考和铺垫**。AI被**严格禁止**直接表演其内容，但可以利用其中的元素（如提及关键人物、地点）来增加叙事的连贯性。这能让AI对即将到来的剧情弧光有一个整体的把握，从而做出更长线的铺垫。

*   **`日历事件` & `可用随机事件`**:
    *   **来源**: `LorebookService` 从世界书读取。
    *   **作用**: 为AI提供日常叙事的“素材库”，当没有主线任务时，AI可以从中选择事件进行演绎。

*   **`系统指令`**:
    *   **来源**: 由多个服务根据条件判断生成，是最高优先级的任务。
    *   **核心示例：日志合成**:
        *   **触发**: `DiarySynthesisService.ts` 检测到日期变更或日记数量达标。
        *   **内容**: 生成如 `<请求合成日记>[{"序号":1, ...}]</请求合成日记>` 的指令。其中包含了**所有**待合成的原始日志数据的JSON字符串。
        *   **作用**: AI的COT被修改为**只有在看到这种包含数据的指令时，才被授权执行合成任务**。这从根本上杜绝了AI“自作主张”进行错误合成的可能性。

### 3.6. `记忆模块`

*   **`相关记忆`**:
    *   **来源**: `MemoryRetrievalService.ts` 的核心产出。
    *   **策略**: 根据用户输入和当前场景，从全部历史 `日记片段` 中，通过复杂的加权评分算法（综合新近度、实体匹配度、社交图谱等），检索出**最相关的Top 3**的事件。
    *   **内容**: 仅包含事件的“[日期 时间片段] 标题”，如`[2013-04-19 放学后] 第一位委托人`。
    *   **优化**: **这是对上下文体积最大、最有效的优化**。它将可能长达数万字的完整历史，浓缩为三行最关键的记忆索引，在不牺牲叙事连贯性的前提下，实现了上下文的极致压缩。

*   **`近期记忆闪回`**:
    *   **策略**: 作为补充，提供最近发生的5个主线事件的简要回顾。
    *   **作用**: 帮助AI维持对短期剧情的连贯性感知。

---

通过以上设计，V3精简上下文系统实现了在保证AI叙事质量和逻辑严谨性的前提下，对上下文体积的极致优化，是整个项目能够长期、稳定运行的核心基石。