# 天华信 (TianhuaChat) App - 数据来源参考

本文档旨在梳理“天华信”App内各项功能的数据来源，明确前端UI与后端世界书/角色变量之间的对应关系。

## 1. 核心数据源

- **角色数据**: 游戏世界中的所有角色（玩家和NPC）都存储在顶层变量 `角色` 对象中。每个角色的唯一ID是其键名，例如 `角色.{{user}}` 或 `角色.yukinoshita_yukino`。
- **世界书 (Lorebook)**: 名为 `天华校园` 的世界书，用于存储持久化的、文本形式的日志和社交内容。

---

## 2. 功能模块数据来源

### 2.1. 联系人列表 (Contacts)

联系人列表是动态生成的，其数据来源复杂，涉及对整个 `角色` 对象的遍历和判断。

- **数据来源**:
    1.  **前端逻辑**: 主要由 `src/campus-card-vue/services/tianhuachat.ts` 中的 `getGroupedContacts` 函数处理。
    2.  **核心变量**: 该函数遍历 `角色` 对象中的所有角色，并检查 `角色.<角色ID>.人际关系` 子对象。
- **分组逻辑**:
    - **新的朋友**: 遍历所有NPC，如果某个NPC的 `人际关系.{{user}}.聊天状态` 为 `"待确认好友"`，则该NPC会出现在这个分组。
    - **群聊**: 读取世界书条目 `聊天群组-主`，解析其中的所有群组信息并展示。
    - **我的同学 / 我的好友**: 遍历玩家的 `人际关系` 对象。如果 `人际关系.<NPC_ID>.聊天状态` 为 `"好友"`，则该NPC被视为好友。前端会进一步根据玩家和该NPC的 `班级` 属性是否相同，将其划分为“我的同学”或“我的好友”。
    - **黑名单**: 如果玩家的 `人际关系.<NPC_ID>.聊天状态` 为 `"黑名单"`，则该NPC会出现在此分组。

### 2.2. 聊天记录 (Messages)

私聊和群聊的记录都存储在世界书中。

- **私聊/群聊数据来源**:
    - **世界书条目**: `聊天会话列表-主`
    - **格式**: 前端从该条目中读取所有 `[私聊|...]` 和 `[群聊|...]` 格式的行，并根据当前选择的聊天对象（私聊或群聊ID）进行过滤和展示。
- **数据生成**:
    - **AI**: AI在 `<NewSocialContent>` 块中生成 `[私聊|...]` 或 `[群聊|...]` 指令。
    - **前端服务**: `src/campus-card-vue/services/SocialService.ts` 中的 `handlePrivateMessage` 和 `handleGroupMessage` 函数捕获这些指令，并将其追加到 `聊天会话列表-主` 世界书条目中。

### 2.3. “空间”动态 (Moments)

“空间”中的动态（朋友圈）同样存储在世界书中。

- **数据来源**:
    - **世界书条目**: `MX空间-主`
- **数据生成**:
    - **AI**: AI在 `<NewSocialContent>` 块中生成 `<mx空间>...</mx空间>` 内容块。
    - **前端服务**: `src/campus-card-vue/services/SocialService.ts` 中的 `handleMomentCreate` 函数捕获这些块，并将其完整地追加到 `MX空间-主` 世界书条目中。

---

## 3. 核心交互与变量联动

- **添加好友**:
    1.  **玩家操作**: 在UI上点击“添加好友”。
    2.  **前端逻辑**: `store/actions.ts` 的 `handleAction` 函数生成 `[好友请求|...]` 指令。
    3.  **AI处理**: AI收到指令后，在其响应的 `<UpdateVariable>` 块中，**必须**使用 `_.set` 指令进行双向状态更新：
        -   `_.set('角色.{{user}}.人际关系.<目标ID>.聊天状态', '请求中')`
        -   `_.set('角色.<目标ID>.人际关系.{{user}}.聊天状态', '待确认好友')`
- **接受好友**:
    1.  **玩家操作**: 在“新的朋友”列表中点击“接受”。
    2.  **前端逻辑**: `store/actions.ts` 生成 `[接受好友|...]` 指令。
    3.  **AI处理**: AI收到指令后，在其响应的 `<UpdateVariable>` 块中，**必须**使用 `_.set` 指令将双方的 `聊天状态` 都更新为 `"好友"`。同时，在 `<NewSocialContent>` 中生成一条由接受方发起的初始问候私聊。

此文档由Roo整理，旨在提供清晰的数据流向参考。