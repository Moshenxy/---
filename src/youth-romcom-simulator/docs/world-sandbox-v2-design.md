# 世界沙盘 V2 - "星图" 优化方案

## 1. 核心目标

当前的世界沙盘（V1）已实现基于 `d3-force` 的力导向布局，但存在两大核心问题：
1.  **布局随机性**: 节点间的相对位置在每次加载时都不同，缺乏地理方位的确定性。
2.  **信息密度低**: 节点和详情面板展示的信息有限，未能充分利用世界书中的丰富数据。

V2 版本的核心目标是解决这两个问题，将世界沙盘从一个“关系图”升级为一个真正的、信息丰富的、布局确定的“**星图**”。

## 2. 优化方案详解

### 2.1. 布局引擎重构：从“力导向”到“方位角”

我们将引入一个基于“方位角”的确定性布局引擎，确保星图的每一次渲染都完全一致，并真实反映世界设定中的地理关系。

#### 2.1.1. 新增 `CoordinateService.ts`

-   **职责**: 专门负责解析 `空间实体.相对坐标` 中的 `方位` 和 `距离` 字段。
-   **核心方法 `getCartesianCoordinates(parentId, relativeCoord)`**:
    1.  接收父节点ID和子节点的相对坐标对象。
    2.  **方位解析**: 将 `['北', 15]` (北偏东15度) 或 `['西南', -10]` (西南方向逆时针10度) 这样的描述性语言，转换为精确的数学角度（弧度制）。
        -   `北` = `+Y`, `东` = `+X`。
        -   `北偏东15度` = `atan2(1, 0) - (15 * PI / 180)`。
    3.  **距离归一化**: 将不同单位（如 `km`, `光年`, `AU`）的 `距离`，根据一个全局缩放比例，转换为统一的屏幕像素单位。
    4.  **坐标计算**: 结合父节点坐标、转换后的角度和像素距离，使用极坐标转笛卡尔坐标公式 (`x = r * cos(θ)`, `y = r * sin(θ)`)，计算出子节点的精确 `(x, y)` 目标位置。

#### 2.1.2. 改造 `ForceLayoutService.ts`

-   **核心思路**: 不再让 D3 完全自由地计算位置，而是为其提供一个“引力中心”，让节点朝向由 `CoordinateService` 计算出的精确位置移动。
-   **改造点**:
    1.  移除或减弱原有的 `forceCenter` 和 `forceManyBody` 的全局影响。
    2.  为每个节点动态添加 `.fx` 和 `.fy` 属性，将其固定到 `CoordinateService` 计算出的精确位置。
    3.  保留 `forceCollide` 以避免节点在视觉上重叠。
    4.  `forceLink` 依然保留，但其作用从“决定距离”变为纯粹的“视觉连接”。

### 2.2. 节点详情面板 (`NodeDetailPanel.vue`) 重构

根据用户反馈，我们将对详情面板进行彻底重构，使其成为一个信息中心。

-   **移除 `ID`**: 移除对用户无意义的内部ID展示。
-   **子节点列表**:
    -   将原有的“子节点数量”替换为一个可滚动的列表。
    -   每一项都是一个子节点的名称，点击后可直接下钻到该节点。
-   **新增“关联资源”板块**:
    -   从 `worldData.内容.资源` 中，筛选出所有 `所属实体ID` 为当前节点ID的资源。
    -   以列表形式展示资源名称、能级和稀有度。
-   **新增“盘踞势力”板块**:
    -   从 `worldData.内容.文明.势力` 和 `worldData.内容.文明.群体` 中，筛选出活动范围包含当前节点的势力/群体。
    -   展示势力名称及其核心目标。

### 2.3. 视觉表现力增强 (`WorldMapView.vue`)

-   **轨道可视化**:
    -   在 `renderD3` 方法中，为每个拥有子节点的父节点，绘制一条以其为圆心、代表其引力范围的虚线圆形“轨道”。
-   **节点差异化**:
    -   **形状/图标**: 根据 `空间实体.层级类型` (如 `大陆`, `国家`, `城市`, `星系`, `行星`)，为节点应用不同的SVG形状或图标。例如，星系用螺旋图标，行星用实心圆，城市用方块。
    -   **辉光/大小**: 根据 `空间实体` 关联的 `世界能级` 或自身 `面积` 数据，动态调整节点的半径和辉光效果，让高能级/大范围的实体在视觉上更突出。

## 3. 任务拆解

1.  **[完成]** 规划世界沙盘V2方案并创建本设计文档。
2.  **[待办]** 创建 `src/reincarnation-simulator/modules/world-map/services/CoordinateService.ts`。
3.  **[待办]** 改造 `ForceLayoutService.ts`，集成 `CoordinateService` 并应用 `.fx`/`.fy` 定位。
4.  **[待办]** 重构 `NodeDetailPanel.vue` 组件，实现新的信息展示布局。
5.  **[待办]** 修改 `WorldMapView.vue` 的 `renderD3` 方法，增加轨道线和差异化节点样式。
6.  **[待办]** 更新 `src/reincarnation-simulator/modules/world-map/README.md` 以反映 V2 版本的新架构。