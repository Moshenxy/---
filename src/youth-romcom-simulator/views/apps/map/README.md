# 地图App (MapApp.vue) 逻辑分析

本文档旨在详细解释“天华校园”前端界面中，地图应用的核心交互逻辑，特别是关于层级切换和视图聚焦的部分。

## 1. 数据源与结构

地图的所有地点信息都存储在 `src/天华校园世界书/[世界观]地点列表.txt` 文件中。该文件通过 `ID` 和 `父级ID` 字段，将所有地点组织成一个层级分明的树状结构。

关键字段包括：
- `ID`: 地点的唯一标识。
- `父级ID`: 定义了层级关系。
- `网格坐标` 和 `网格尺寸`: 用于在二维平面上进行布局和渲染。

## 2. 核心交互：下钻与聚焦

地图的核心交互是允许用户在不同层级的地点之间进行探索。这主要通过“下钻”和“返回”两个操作实现。

### 2.1. 状态管理

组件内部维护一个关键的状态变量 `activeContextId`，它代表着当前地图所展示层级的“父级ID”。
- 当 `activeContextId` 为 `null` 时，显示所有顶层地点。
- 当 `activeContextId` 为某个地点的ID时，显示该地点的所有直接子地点。

### 2.2. 进入下一层级 (Drill Down)

- **触发方式**: 用户在地图上 **双击** 某个地点方块。
- **内部逻辑**:
    1.  `@dblclick` 事件触发 `drillDown(location)` 函数。
    2.  该函数检查被点击的 `location` 是否有子节点。
    3.  若有，则将 `activeContextId` 更新为该 `location` 的 `id`。
    4.  `activeContextId` 的变化会触发 `watch` 监听器，从而调用 `loadMapData()` 函数。
    5.  `loadMapData()` 会根据新的 `activeContextId` 筛选出对应的子地点列表，并更新地图视图。
    6.  **自动聚焦**: 在数据更新后，`panzoom` 库会计算所有新显示地点的边界，并自动调整缩放和平移，将新层级完整、居中地呈现在用户面前。

### 2.3. 返回上一层级

- **触发方式**: 用户点击界面顶部的**面包屑导航**栏。
- **内部逻辑**:
    1.  面包屑导航栏的每一项都记录了其对应的层级ID (`contextId`)。
    2.  点击触发 `goBack(index)` 函数。
    3.  该函数将 `activeContextId` 设置为被点击层级的 `contextId`。
    4.  后续流程与“下钻”相同，地图会重新加载并聚焦到指定的上级层级。

## 3. 总结

地图APP通过响应用户的双击和点击事件，动态地改变当前的层级上下文ID (`activeContextId`)。每一次上下文的改变，都会驱动数据重新加载和视图的自动聚焦，从而实现了在复杂地点层级中流畅、直观的导航体验。
